{% extends "base.html" %}

{% block title %}Lead Details - Smart CRM{% endblock %}

{% block content %}
<div class="content-container" style="margin: 0; padding: 0; width: 100%;">
    <!-- Header -->
    <div class="content-header" style="margin-bottom: 25px; padding: 20px; background: #0d6efd; border-radius: 12px; color: white; box-shadow: 0 4px 20px rgba(13, 110, 253, 0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div>
                <h2 style="margin: 0; font-weight: 700; font-size: 2rem; color: white;">
                    <i class="fas fa-user-tie" style="margin-right: 10px;"></i>
                    Lead Details
                </h2>
                <div style="font-size: 1em; opacity: 0.9; margin-top: 8px;">
                    View and manage lead information
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/leads" class="btn" style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-left"></i> Back to Leads
                </a>
                <div class="stat-badge" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-hashtag"></i>
                    <span>Lead ID: <strong id="lead-id-badge">{{ lead_id }}</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Overview Card -->
    <div class="lead-overview" style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
            <div>
                <h3 id="lead-company" style="margin: 0 0 10px 0; font-size: 1.8rem; font-weight: 700; color: #212529;">
                    <i class="fas fa-building" style="color: #0d6efd; margin-right: 10px;"></i>
                    <span id="company-name">Loading...</span>
                </h3>
                <div id="lead-customer" style="font-size: 1.1em; color: #495057; margin-bottom: 15px;">
                    <i class="fas fa-user" style="color: #0d6efd; margin-right: 8px;"></i>
                    <span id="customer-name">Loading...</span>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #6c757d;">
                        <i class="fas fa-calendar"></i>
                        <span>Created: <strong id="created-date">-</strong></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: #6c757d;">
                        <i class="fas fa-sync-alt"></i>
                        <span>Updated: <strong id="updated-date">-</strong></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: #6c757d;">
                        <i class="fas fa-user-tie"></i>
                        <span>Owner: <strong id="lead-owner">-</strong></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: #6c757d;">
                        <i class="fas fa-clock"></i>
                        <span>Aging: <strong id="lead-aging">-</strong> days</span>
                    </div>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div id="lead-status" class="status-badge" style="padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 1.1em; display: inline-flex; align-items: center; gap: 8px; align-self: flex-end;">
                    <i class="fas fa-circle" style="font-size: 0.8em;"></i>
                    <span>Loading...</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <a href="/lead-reports/{{ lead_id }}" class="btn btn-success" style="padding: 10px 20px; font-size: 1em; background: #198754; border: none; border-radius: 8px; color: white; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar"></i> View Reports
                    </a>
                    {% if user.permissions.can_edit_leads %}
                    <a href="/edit-lead/{{ lead_id }}" class="btn btn-primary" style="padding: 10px 20px; font-size: 1em; background: #0d6efd; border: none; border-radius: 8px; color: white; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-edit"></i> Edit Lead
                    </a>
                    {% endif %}
                    <button onclick="openStatusModal()" class="btn btn-info" style="padding: 10px 20px; font-size: 1em; background: #0d6efd; border: none; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sync-alt"></i> Update Status
                    </button>
                    {% if user.permissions.can_delete_leads %}
                    <button onclick="deleteLead()" class="btn btn-danger" style="padding: 10px 20px; font-size: 1em; background: #dc3545; border: none; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="detail-tabs" style="display: flex; margin-bottom: 25px; flex-wrap: wrap; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
        <button class="tab-btn active" data-tab="details" style="padding: 12px 24px; background: #0d6efd; border: none; border-radius: 8px; font-size: 1em; font-weight: 500; color: white; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 5px; transition: all 0.3s;">
            <i class="fas fa-info-circle"></i> Details
        </button>
        <button class="tab-btn" data-tab="activities" style="padding: 12px 24px; background: white; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; font-weight: 500; color: #495057; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 5px; transition: all 0.3s;">
            <i class="fas fa-history"></i> Activities
        </button>
        <button class="tab-btn" data-tab="status-history" style="padding: 12px 24px; background: white; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; font-weight: 500; color: #495057; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 5px; transition: all 0.3s;">
            <i class="fas fa-stream"></i> Status History
        </button>
        <button class="tab-btn" data-tab="changes" style="padding: 12px 24px; background: white; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; font-weight: 500; color: #495057; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 5px; transition: all 0.3s;">
            <i class="fas fa-exchange-alt"></i> Changes
        </button>
    </div>

    <!-- Details Tab -->
    <div id="details" class="tab-content active" style="display: block;">
        <div class="info-card" style="background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 25px 0; padding-bottom: 15px; border-bottom: 2px solid #dee2e6; font-size: 1.4em; font-weight: 700; color: #212529; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-list-ul" style="color: #0d6efd;"></i>
                Lead Information
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- Lead ID -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead ID</label>
                    <div id="info-lead-id" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Staff Location -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Staff Location</label>
                    <div id="info-staff-location" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Date -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead Date</label>
                    <div id="info-lead-date" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Source -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead Source</label>
                    <div id="info-lead-source" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Type -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead Type</label>
                    <div id="info-lead-type" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Owner -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead Owner</label>
                    <div id="info-lead-owner" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Status -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead Status</label>
                    <div id="info-lead-status" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Company Name -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Company Name</label>
                    <div id="info-company-name" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Industry Type -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Industry Type</label>
                    <div id="info-industry-type" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Sub Industry -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Sub Industry</label>
                    <div id="info-sub-industry" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- System -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">System</label>
                    <div id="info-system" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Project/AMC -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Project/AMC</label>
                    <div id="info-project-amc" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Customer Name -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Customer Name</label>
                    <div id="info-customer-name" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Customer Designation -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Customer Designation</label>
                    <div id="info-designation-customer" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Contact Phone -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Contact No</label>
                    <div id="info-contact-no" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Contact Email -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Email</label>
                    <div id="info-email-id" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- LinkedIn Profile -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">LinkedIn</label>
                    <div id="info-linkedin-profile" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- State -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">State</label>
                    <div id="info-state" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- District -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">District</label>
                    <div id="info-district" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- City -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">City</label>
                    <div id="info-city" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- PIN Code -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">PIN Code</label>
                    <div id="info-pin-code" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Full Address -->
                <div style="display: flex; flex-direction: column; grid-column: span 2;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Full Address</label>
                    <div id="info-full-address" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd; line-height: 1.6;">-</div>
                </div>
                <!-- Company Website -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Company Website</label>
                    <div id="info-company-website" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Company LinkedIn -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Company LinkedIn</label>
                    <div id="info-company-linkedin-link" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- GSTIN -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">GSTIN</label>
                    <div id="info-gstin" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Payment Term -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Payment Term</label>
                    <div id="info-payment-term" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Margin % -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Margin %</label>
                    <div id="info-margin-percent" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Gross Margin Amount -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Gross Margin Amount</label>
                    <div id="info-gross-margin-amount" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Net Margin Amount -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Net Margin Amount</label>
                    <div id="info-net-margin-amount" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Received Amount -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Received Amount</label>
                    <div id="info-received-amount" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Balance Amount -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Balance Amount</label>
                    <div id="info-balance-amount" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Closer Date -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead Closer Date</label>
                    <div id="info-lead-closer-date" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Expected Lead Closer Month -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Expected Lead Closer Month</label>
                    <div id="info-expected-lead-closer-month" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Method of Communication -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Method of Communication</label>
                    <div id="info-method-of-communication" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Purpose of Meeting -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Purpose of Meeting</label>
                    <div id="info-purpose-of-meeting" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Meeting Outcome -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Meeting Outcome</label>
                    <div id="info-meeting-outcome" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Next Follow-up -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Next Follow-up</label>
                    <div id="info-next-follow-up-date" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Prospect -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Prospect</label>
                    <div id="info-prospect" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Approx Value -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Approx Value</label>
                    <div id="info-approx-value" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Negotiated Value -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Negotiated Value</label>
                    <div id="info-negotiated-value" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Closing Amount -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Closing Amount</label>
                    <div id="info-closing-amount" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Aging -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Aging (Days)</label>
                    <div id="info-lead-aging" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Lead Percentage -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Lead %</label>
                    <div id="info-lead-percentage" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Created By -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Created By</label>
                    <div id="info-created-by-name" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Assigned To -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Assigned To</label>
                    <div id="info-assigned-to-name" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Created At -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Created At</label>
                    <div id="info-created-at" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Updated At -->
                <div style="display: flex; flex-direction: column;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Updated At</label>
                    <div id="info-updated-at" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd;">-</div>
                </div>
                <!-- Discussion Held -->
                <div style="display: flex; flex-direction: column; grid-column: span 2;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Discussion Held</label>
                    <div id="info-discussion-held" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd; line-height: 1.6;">-</div>
                </div>
                <!-- Remarks -->
                <div style="display: flex; flex-direction: column; grid-column: span 2;">
                    <label style="color: #6c757d; font-size: 0.9em; font-weight: 600; margin-bottom: 6px;">Remarks</label>
                    <div id="info-remarks" style="color: #212529; font-weight: 500; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #0d6efd; line-height: 1.6;">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activities Tab -->
    <div id="activities" class="tab-content" style="display: none;">
        <div class="activities-list" style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #dee2e6; font-size: 1.3em; font-weight: 600; color: #212529; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-history" style="color: #0d6efd;"></i>
                Activities Timeline
            </h4>
            <div id="activities-container" style="max-height: 500px; overflow-y: auto;">
                <div class="activity-loading" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 20px; color: #0d6efd;"></i>
                    <p style="font-size: 1.1em;">Loading activities...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Status History Tab -->
    <div id="status-history" class="tab-content" style="display: none;">
        <div class="status-history" style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #dee2e6; font-size: 1.3em; font-weight: 600; color: #212529; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-stream" style="color: #0d6efd;"></i>
                Status History
            </h4>
            <div id="status-history-container" style="max-height: 500px; overflow-y: auto;">
                <div class="status-loading" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 20px; color: #0d6efd;"></i>
                    <p style="font-size: 1.1em;">Loading status history...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Changes History Tab -->
    <div id="changes" class="tab-content" style="display: none;">
        <div class="changes-history" style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #dee2e6; font-size: 1.3em; font-weight: 600; color: #212529; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exchange-alt" style="color: #0d6efd;"></i>
                Field Changes
            </h4>
            <div id="changes-container" style="max-height: 500px; overflow-y: auto;">
                <div class="changes-loading" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 20px; color: #0d6efd;"></i>
                    <p style="font-size: 1.1em;">Loading changes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Lead Modal (all except company info) -->
<div id="statusModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(13, 110, 253, 0.8); align-items: center; justify-content: center;">
    <div class="modal-content" style="background-color: white; margin: auto; padding: 0; width: 95%; max-width: 760px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; max-height: 85vh; display: flex; flex-direction: column; border: 2px solid #dee2e6;">
        <div style="padding: 20px 25px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; background: #0d6efd; border-radius: 16px 16px 0 0; color: white;">
            <h3 style="margin: 0; font-size: 1.2em; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-edit"></i>
                Update Lead (Except Company Info)
            </h3>
            <button onclick="closeStatusModal()" style="background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-size: 1.2em; transition: background 0.2s;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="padding: 20px 25px; overflow-y: auto;">
            <form id="statusForm">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">
                    <div>
                        <label class="modal-label"><i class="fas fa-flag"></i> Status</label>
                        <select id="newStatus" class="modal-input" data-setting="statuses" required>
                            <option value="">Select Status</option>
                        </select>
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-comments"></i> Comm Method</label>
                        <select id="modalCommMethod" class="modal-input" data-setting="communication_method">
                            <option value="">Select Communication Method</option>
                        </select>
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-bullhorn"></i> Purpose of Meeting</label>
                        <select id="modalPurpose" data-setting="purpose_of_meeting" class="modal-input">
                            <option value="">Select Purpose</option>
                        </select>
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-user-check"></i> Assigned To</label>
                        <select id="modalAssignedTo" class="modal-input"></select>
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-user"></i> Customer Name</label>
                        <input id="modalCustomer" class="modal-input" placeholder="Customer name">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-id-badge"></i> Customer Designation</label>
                        <input id="modalDesignationCustomer" class="modal-input" placeholder="Designation">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-envelope"></i> Email</label>
                        <input id="modalEmail" type="email" class="modal-input" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-phone"></i> Contact No</label>
                        <input id="modalPhone" class="modal-input" placeholder="Phone number">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fab fa-linkedin"></i> LinkedIn</label>
                        <input id="modalLinkedIn" class="modal-input" placeholder="https://...">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-calendar-check"></i> Next Follow-up</label>
                        <input id="modalNextFollow" type="date" class="modal-input">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-lightbulb"></i> Prospect</label>
                        <select id="modalProspect" data-setting="prospect" class="modal-input">
                            <option value="">Select Prospect</option>
                        </select>
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Approx Value</label>
                        <input id="modalApprox" type="number" step="0.01" class="modal-input" placeholder="0">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Negotiated Value</label>
                        <input id="modalNegotiated" type="number" step="0.01" class="modal-input" placeholder="0" readonly style="background: #f8f9fa; color: #495057; cursor: not-allowed;">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Closing Amount</label>
                        <input id="modalClosing" type="number" step="0.01" class="modal-input" placeholder="0">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-percentage"></i> Lead % <span style="font-size: 0.85em; color: #6c757d;">(Auto-calculated)</span></label>
                        <input id="modalLeadPct" type="number" min="0" max="100" class="modal-input" placeholder="0-100" readonly style="background: #f8f9fa; color: #495057; cursor: not-allowed;">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-handshake"></i> Meeting Outcome</label>
                        <input id="modalMeetingOutcome" class="modal-input" placeholder="Outcome">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-comment-dots"></i> Discussion Held</label>
                        <input id="modalDiscussion" class="modal-input" placeholder="Key discussion points">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-percentage"></i> Margin %</label>
                        <input id="modalMarginPercent" name="margin_percent" type="number" step="0.01" class="modal-input" placeholder="Enter margin %">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Gross Margin Amount</label>
                        <input id="modalGrossMarginAmount" name="gross_margin_amount" type="number" step="0.01" class="modal-input" placeholder="Enter gross margin amount" readonly style="background: #f8f9fa; color: #495057; cursor: not-allowed;">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Net Margin Amount</label>
                        <input id="modalNetMarginAmount" name="net_margin_amount" type="number" step="0.01" class="modal-input" placeholder="Enter net margin amount" readonly style="background: #f8f9fa; color: #495057; cursor: not-allowed;">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Received Amount</label>
                        <input id="modalReceivedAmount" name="received_amount" type="number" step="0.01" class="modal-input" placeholder="Enter received amount">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-rupee-sign"></i> Balance Amount</label>
                        <input id="modalBalanceAmount" name="balance_amount" type="number" step="0.01" class="modal-input" placeholder="Enter balance amount" readonly style="background: #f8f9fa; color: #495057; cursor: not-allowed;">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-calendar"></i> Lead Closer Date</label>
                        <input id="modalLeadCloserDate" name="lead_closer_date" type="date" class="modal-input">
                    </div>
                    <div>
                        <label class="modal-label"><i class="fas fa-calendar-alt"></i> Expected Lead Closer Month</label>
                        <input id="modalExpectedLeadCloserMonth" name="expected_lead_closer_month" type="month" class="modal-input">
                    </div>
                </div>
                <div style="margin-top: 16px;">
                    <label class="modal-label"><i class="fas fa-sticky-note"></i> Remarks</label>
                    <textarea id="statusRemarks" class="modal-input" style="min-height: 100px; resize: vertical;" placeholder="Add remarks..."></textarea>
                </div>
            </form>
        </div>
        <div style="padding: 20px 25px; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; border-radius: 0 0 16px 16px;">
            <button onclick="closeStatusModal()" class="btn" style="padding: 10px 20px; font-size: 1em; background: white; color: #6c757d; border: 1px solid #dee2e6; border-radius: 8px; font-weight: 500;">
                Cancel
            </button>
            <button type="submit" form="statusForm" class="btn" style="padding: 10px 20px; font-size: 1em; background: #0d6efd; color: white; border: none; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-check"></i> Update Lead
            </button>
        </div>
    </div>
</div>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
let leadData = null;
let leadId = '{{ lead_id }}';
let activeUsers = [];

// Status colors matching your reference HTML theme
const statusColors = {
    'New': { bg: '#0d6efd', color: 'white', icon: 'star' },
    'Contacted': { bg: '#0dcaf0', color: 'white', icon: 'phone' },
    'Qualified': { bg: '#198754', color: 'white', icon: 'check-circle' },
    'Proposal Sent': { bg: '#ffc107', color: 'black', icon: 'paper-plane' },
    'Negotiation': { bg: '#6f42c1', color: 'white', icon: 'handshake' },
    'Won': { bg: '#198754', color: 'white', icon: 'trophy' },
    'Lost': { bg: '#dc3545', color: 'white', icon: 'times-circle' }
};

// Check authentication and load lead data
async function checkAuth() {
    try {
        const response = await fetch('/api/validate-session');
        if (!response.ok) {
            window.location.href = '/';
            return;
        }
        
        loadLeadData();
    } catch (error) {
        window.location.href = '/';
    }
}

async function loadLeadData() {
    try {
        showLoading(true);
        
        const response = await fetch(`/api/leads/${leadId}`);
        const data = await response.json();
        
        if (data.success) {
            leadData = data.lead;
            // Expose field_history and status_history globally for activity tab
            window.leadFieldHistory = data.field_history || [];
            window.leadStatusHistory = data.status_history || [];
            updateLeadDetails();
            loadActivities();
            loadStatusHistory();
            // Merge status history and field history for unified change tracking
            const allChanges = mergeFieldAndStatusHistory(window.leadFieldHistory, window.leadStatusHistory);
            loadFieldChanges(allChanges);
            // Load active users once and then update assigned-to value
            if (!activeUsers.length) {
                await loadActiveUsers();
            }
        } else {
            showNotification('error', data.detail || 'Failed to load lead details');
        }
    } catch (error) {
        console.error('Error loading lead:', error);
        showNotification('error', 'Failed to load lead details');
    } finally {
        showLoading(false);
    }
}

function updateLeadDetails() {
    if (!leadData) return;
    
    // Update header information
    document.getElementById('lead-id-badge').textContent = leadData.lead_id;
    document.getElementById('company-name').textContent = leadData.company_name || 'N/A';
    document.getElementById('customer-name').textContent = leadData.customer_name || 'N/A';
    document.getElementById('created-date').textContent = formatDate(leadData.created_at || leadData.lead_date) || '-';
    document.getElementById('updated-date').textContent = formatDateTimeSafe(leadData.updated_at) || '-';
    document.getElementById('lead-owner').textContent = leadData.lead_owner || '-';
    
    // Calculate and update lead aging
    const age = typeof leadData.lead_aging === 'number' ? leadData.lead_aging : (function(){
        const leadDate = new Date(leadData.lead_date);
        const today = new Date();
        return Math.floor((today - leadDate) / (1000 * 60 * 60 * 24));
    })();
    document.getElementById('lead-aging').textContent = age;
    
    // Update status badge
    const status = leadData.lead_status || 'New';
    const statusConfig = statusColors[status] || statusColors['New'];
    const statusBadge = document.getElementById('lead-status');
    statusBadge.innerHTML = `<i class="fas fa-${statusConfig.icon}"></i> ${status}`;
    statusBadge.style.background = statusConfig.bg;
    statusBadge.style.color = statusConfig.color;
    
    // Update all fields in the unified form card
    document.getElementById('info-lead-id').textContent = leadData.lead_id || '-';
    document.getElementById('info-staff-location').textContent = leadData.staff_location || '-';
    document.getElementById('info-lead-date').textContent = formatDate(leadData.lead_date) || '-';
    document.getElementById('info-lead-source').textContent = leadData.lead_source || '-';
    document.getElementById('info-lead-type').textContent = leadData.lead_type || '-';
    document.getElementById('info-lead-owner').textContent = leadData.lead_owner || '-';
    document.getElementById('info-lead-status').textContent = leadData.lead_status || '-';
    document.getElementById('info-company-name').textContent = leadData.company_name || '-';
    document.getElementById('info-industry-type').textContent = leadData.industry_type || '-';
    document.getElementById('info-sub-industry').textContent = leadData.sub_industry || '-';
    document.getElementById('info-system').textContent = leadData.system || '-';
    document.getElementById('info-project-amc').textContent = leadData.project_amc || '-';
    document.getElementById('info-customer-name').textContent = leadData.customer_name || '-';
    document.getElementById('info-designation-customer').textContent = leadData.designation_customer || '-';
    document.getElementById('info-contact-no').innerHTML = leadData.contact_no ? 
        `<a href="tel:${leadData.contact_no}" style="color: #0d6efd; text-decoration: none;">${leadData.contact_no}</a>` : '-';
    document.getElementById('info-email-id').innerHTML = leadData.email_id ? 
        `<a href="mailto:${leadData.email_id}" style="color: #0d6efd; text-decoration: none;">${leadData.email_id}</a>` : '-';
    document.getElementById('info-linkedin-profile').innerHTML = leadData.linkedin_profile ? 
        `<a href="${leadData.linkedin_profile}" target="_blank" style="color: #0d6efd; text-decoration: none;">View Profile</a>` : '-';
    document.getElementById('info-state').textContent = leadData.state || '-';
    document.getElementById('info-district').textContent = leadData.district || '-';
    document.getElementById('info-city').textContent = leadData.city || '-';
    document.getElementById('info-pin-code').textContent = leadData.pin_code || '-';
    document.getElementById('info-full-address').textContent = leadData.full_address || '-';
    document.getElementById('info-company-website').innerHTML = leadData.company_website ? 
        `<a href="${leadData.company_website}" target="_blank" style="color: #0d6efd; text-decoration: none;">Visit Website</a>` : '-';
    document.getElementById('info-company-linkedin-link').innerHTML = leadData.company_linkedin_link ? 
        `<a href="${leadData.company_linkedin_link}" target="_blank" style="color: #0d6efd; text-decoration: none;">View Company</a>` : '-';
    document.getElementById('info-gstin').textContent = leadData.gstin || '-';
    document.getElementById('info-payment-term').textContent = leadData.payment_term || '-';
    document.getElementById('info-margin-percent').textContent = leadData.margin_percent != null ? leadData.margin_percent + '%' : '-';
    document.getElementById('info-gross-margin-amount').textContent = leadData.gross_margin_amount != null ? `${parseNumber(leadData.gross_margin_amount).toLocaleString()}` : '-';
    document.getElementById('info-net-margin-amount').textContent = leadData.net_margin_amount != null ? `${parseNumber(leadData.net_margin_amount).toLocaleString()}` : '-';
    document.getElementById('info-received-amount').textContent = leadData.received_amount != null ? `${parseNumber(leadData.received_amount).toLocaleString()}` : '-';
    document.getElementById('info-balance-amount').textContent = leadData.balance_amount != null ? `${parseNumber(leadData.balance_amount).toLocaleString()}` : '-';
    document.getElementById('info-lead-closer-date').textContent = leadData.lead_closer_date ? formatDate(leadData.lead_closer_date) : '-';
    document.getElementById('info-expected-lead-closer-month').textContent = leadData.expected_lead_closer_month || '-';
    document.getElementById('info-method-of-communication').textContent = leadData.method_of_communication || '-';
    document.getElementById('info-purpose-of-meeting').textContent = leadData.purpose_of_meeting || '-';
    document.getElementById('info-meeting-outcome').textContent = leadData.meeting_outcome || '-';
    const nextFollowDisplay = leadData.next_follow_up_date ? formatDate(leadData.next_follow_up_date) : '';
    document.getElementById('info-next-follow-up-date').textContent = nextFollowDisplay;
    document.getElementById('info-prospect').textContent = leadData.prospect || '-';
    document.getElementById('info-approx-value').textContent = leadData.approx_value ? `${parseNumber(leadData.approx_value).toLocaleString()}` : '-';
    document.getElementById('info-negotiated-value').textContent = leadData.negotiated_value ? `${parseNumber(leadData.negotiated_value).toLocaleString()}` : '-';
    document.getElementById('info-closing-amount').textContent = leadData.closing_amount ? `${parseNumber(leadData.closing_amount).toLocaleString()}` : '-';
    document.getElementById('info-lead-aging').textContent = age + ' days' || '-';
    document.getElementById('info-lead-percentage').innerHTML = leadData.lead_percentage ? 
        `<div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex-grow: 1;">
                <div style="height: 8px; background: #dee2e6; border-radius: 4px; overflow: hidden;">
                    <div style="width: ${leadData.lead_percentage}%; height: 100%; background: #0d6efd; border-radius: 4px;"></div>
                </div>
            </div>
            <div style="font-weight: 600; color: #0d6efd; min-width: 40px;">${leadData.lead_percentage}%</div>
        </div>` : '-';
    document.getElementById('info-created-by-name').textContent = leadData.created_by_name || '-';
    document.getElementById('info-assigned-to-name').textContent = leadData.assigned_to_name || '-';
    document.getElementById('info-created-at').textContent = formatDateTimeSafe(leadData.created_at) || '-';
    document.getElementById('info-updated-at').textContent = formatDateTimeSafe(leadData.updated_at) || '-';
    document.getElementById('info-discussion-held').textContent = leadData.discussion_held || '-';
    document.getElementById('info-remarks').textContent = leadData.remarks || '-';
}

async function loadActivities() {
    try {
        const response = await fetch(`/api/leads/${leadId}`);
        const data = await response.json();
        
        if (data.success && data.activities && data.activities.length > 0) {
            updateActivities(data.activities);
        } else {
            document.getElementById('activities-container').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="fas fa-history" style="font-size: 3em; margin-bottom: 20px; color: #dee2e6;"></i>
                    <p style="font-size: 1.1em;">No activities found for this lead</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading activities:', error);
        document.getElementById('activities-container').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <i class="fas fa-exclamation-circle" style="font-size: 3em; margin-bottom: 20px; color: #dc3545;"></i>
                <p style="font-size: 1.1em;">Failed to load activities</p>
            </div>
        `;
    }
}

function updateActivities(activities) {
    const container = document.getElementById('activities-container');
    
    let html = '';
    // Try to get field_history and status_history from global if available
    let fieldHistory = window.leadFieldHistory || [];
    let statusHistory = window.leadStatusHistory || [];
    activities.forEach(activity => {
        const date = new Date(activity.activity_date);
        const formattedDate = formatDateTime(date);
        const icon = getActivityIcon(activity.activity_type);
        let detailsHtml = '';
        // Show field changes for update/status_change
        if ((activity.activity_type === 'updated' || activity.activity_type === 'status_change')) {
            // Prefer activity.changes if present
            if (activity.changes && Array.isArray(activity.changes) && activity.changes.length > 0) {
                detailsHtml += '<ul style="margin: 8px 0 0 0; padding-left: 18px; color: #495057; font-size: 0.98em;">';
                activity.changes.forEach(change => {
                    const field = (change.field_name || '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    detailsHtml += `<li><strong>${field}:</strong> <span style="color:#dc3545;">${formatNullable(change.old_value)}</span> <i class="fas fa-arrow-right" style="color:#0d6efd;"></i> <span style="color:#198754;">${formatNullable(change.new_value)}</span></li>`;
                });
                detailsHtml += '</ul>';
            } else {
                // Try to match activity.description to field_history/status_history for exact change
                let matched = false;
                // Try field history
                if (fieldHistory && Array.isArray(fieldHistory)) {
                    fieldHistory.forEach(fh => {
                        if (fh.changed_at && Math.abs(new Date(fh.changed_at) - date) < 60000 && activity.performed_by_name === fh.changed_by_name) {
                            // Show only if values are different
                            if ((fh.old_value || '') !== (fh.new_value || '')) {
                                const field = (fh.field_name || '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                detailsHtml += `<ul style=\"margin: 8px 0 0 0; padding-left: 18px; color: #495057; font-size: 0.98em;\"><li><strong>${field}:</strong> <span style=\"color:#dc3545;\">${formatNullable(fh.old_value)}</span> <i class=\"fas fa-arrow-right\" style=\"color:#0d6efd;\"></i> <span style=\"color:#198754;\">${formatNullable(fh.new_value)}</span></li></ul>`;
                                matched = true;
                            }
                        }
                    });
                }
                // Try status history if not matched
                if (!matched && statusHistory && Array.isArray(statusHistory)) {
                    statusHistory.forEach(sh => {
                        if (sh.changed_at && Math.abs(new Date(sh.changed_at) - date) < 60000 && activity.performed_by_name === sh.changed_by_name) {
                            if ((sh.old_status || '') !== (sh.new_status || '')) {
                                detailsHtml += `<ul style=\"margin: 8px 0 0 0; padding-left: 18px; color: #495057; font-size: 0.98em;\"><li><strong>Status:</strong> <span style=\"color:#dc3545;\">${formatNullable(sh.old_status)}</span> <i class=\"fas fa-arrow-right\" style=\"color:#0d6efd;\"></i> <span style=\"color:#198754;\">${formatNullable(sh.new_status)}</span></li></ul>`;
                                matched = true;
                            }
                        }
                    });
                }
            }
        }
        html += `
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: flex-start; gap: 15px;">
                <div style="background: #0d6efd; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    <i class="fas fa-${icon}" style="font-size: 1.2em;"></i>
                </div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; color: #212529; margin-bottom: 5px; font-size: 1.1em;">
                        ${activity.description}
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <span style="padding:4px 8px; background:#f1f5f9; border:1px solid #dee2e6; border-radius:6px; font-size:0.8em; color:#6c757d; text-transform:uppercase;">
                            ${activity.activity_type}
                        </span>
                        <span style="color: #6c757d; font-size: 0.95em;">
                            <i class="fas fa-user"></i> ${activity.performed_by_name || 'Unknown'} 
                            <span style="margin: 0 10px;"></span>
                            <i class="fas fa-clock"></i> ${formattedDate}
                        </span>
                    </div>
                    ${detailsHtml}
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

async function loadStatusHistory() {
    try {
        const response = await fetch(`/api/leads/${leadId}`);
        const data = await response.json();
        
        if (data.success && data.status_history && data.status_history.length > 0) {
            updateStatusHistory(data.status_history);
        } else {
            document.getElementById('status-history-container').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="fas fa-stream" style="font-size: 3em; margin-bottom: 20px; color: #dee2e6;"></i>
                    <p style="font-size: 1.1em;">No status history found</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading status history:', error);
        document.getElementById('status-history-container').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <i class="fas fa-exclamation-circle" style="font-size: 3em; margin-bottom: 20px; color: #dc3545;"></i>
                <p style="font-size: 1.1em;">Failed to load status history</p>
            </div>
        `;
    }
}

function updateStatusHistory(history) {
    const container = document.getElementById('status-history-container');
    
    let html = '<div style="position: relative; padding-left: 40px;">';
    html += '<div style="position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: #dee2e6;"></div>';
    
    history.forEach((item, index) => {
        const date = new Date(item.changed_at);
        const formattedDate = formatDateTime(date);
        const fromStatus = item.old_status || 'New';
        const toStatus = item.new_status || 'New';
        
        html += `
            <div style="position: relative; margin-bottom: 30px;">
                <div style="position: absolute; left: -30px; top: 0; width: 20px; height: 20px; border-radius: 50%; background: #0d6efd; border: 4px solid white; box-shadow: 0 0 0 2px #0d6efd;"></div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="padding: 6px 12px; background: #f8f9fa; border-radius: 6px; color: #6c757d; font-weight: 500; font-size: 0.95em;">
                                ${fromStatus}
                            </span>
                            <i class="fas fa-arrow-right" style="color: #0d6efd;"></i>
                            <span style="padding: 6px 12px; background: #e7f1ff; border-radius: 6px; color: #0d6efd; font-weight: 600; font-size: 0.95em;">
                                ${toStatus}
                            </span>
                        </div>
                        <div style="color: #6c757d; font-size: 0.9em;">
                            <i class="fas fa-clock"></i> ${formattedDate}
                        </div>
                    </div>
                    ${item.remarks ? `
                        <div style="color: #495057; font-size: 0.95em; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #0d6efd;">
                            <i class="fas fa-comment" style="margin-right: 8px; color: #0d6efd;"></i>
                            ${item.remarks}
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                        <i class="fas fa-user"></i> Changed by: ${item.changed_by_name || 'Unknown'}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Merge field history and status history into a unified change list
function mergeFieldAndStatusHistory(fieldHistory, statusHistory) {
    const merged = [];
    
    // Add field history items
    if (fieldHistory && Array.isArray(fieldHistory)) {
        fieldHistory.forEach(item => {
            merged.push({
                field_name: item.field_name,
                old_value: item.old_value,
                new_value: item.new_value,
                changed_by_name: item.changed_by_name,
                changed_at: item.changed_at
            });
        });
    }
    
    // Add status history items (as field changes with field_name = 'lead_status')
    if (statusHistory && Array.isArray(statusHistory)) {
        statusHistory.forEach(item => {
            merged.push({
                field_name: 'lead_status',
                old_value: item.old_status,
                new_value: item.new_status,
                changed_by_name: item.changed_by_name,
                changed_at: item.changed_at
            });
        });
    }
    
    // Sort by changed_at descending (most recent first)
    merged.sort((a, b) => new Date(b.changed_at) - new Date(a.changed_at));
    return merged;
}

function loadFieldChanges(fieldHistory) {
    const container = document.getElementById('changes-container');
    if (!fieldHistory || fieldHistory.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <i class="fas fa-exchange-alt" style="font-size: 3em; margin-bottom: 20px; color: #dee2e6;"></i>
                <p style="font-size: 1.1em;">No field changes recorded</p>
            </div>
        `;
        return;
    }

    // Filter out unnecessary changes (where old_value and new_value are both empty or same)
    const actualChanges = fieldHistory.filter(item => {
        const oldVal = item.old_value?.toString().trim() || '';
        const newVal = item.new_value?.toString().trim() || '';
        // Only show if there's an actual difference
        return oldVal !== newVal;
    });

    if (actualChanges.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <i class="fas fa-exchange-alt" style="font-size: 3em; margin-bottom: 20px; color: #dee2e6;"></i>
                <p style="font-size: 1.1em;">No field changes recorded</p>
            </div>
        `;
        return;
    }

    let html = '<div style="overflow-x: auto;">';
    html += '<table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr>' +
            '<th style="text-align:left; padding:10px; border-bottom:1px solid #dee2e6; color:#6c757d;">Field</th>' +
            '<th style="text-align:left; padding:10px; border-bottom:1px solid #dee2e6; color:#6c757d;">Old Value</th>' +
            '<th style="text-align:left; padding:10px; border-bottom:1px solid #dee2e6; color:#6c757d;">New Value</th>' +
            '<th style="text-align:left; padding:10px; border-bottom:1px solid #dee2e6; color:#6c757d;">Changed By</th>' +
            '<th style="text-align:left; padding:10px; border-bottom:1px solid #dee2e6; color:#6c757d;">Changed At</th>' +
            '</tr></thead><tbody>';

    actualChanges.forEach(item => {
        const dt = new Date(item.changed_at);
        const when = formatDateTime(dt);
        // Format field name - convert snake_case to Title Case
        const fieldNameDisplay = item.field_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `<tr>
            <td style="padding:10px; border-bottom:1px solid #f1f5f9; font-weight:600; color:#212529;">${fieldNameDisplay}</td>
            <td style="padding:10px; border-bottom:1px solid #f1f5f9; color:#6c757d;">${formatNullable(item.old_value)}</td>
            <td style="padding:10px; border-bottom:1px solid #f1f5f9; color:#0d6efd; font-weight:600;">${formatNullable(item.new_value)}</td>
            <td style="padding:10px; border-bottom:1px solid #f1f5f9; color:#6c757d;">${item.changed_by_name || 'Unknown'}</td>
            <td style="padding:10px; border-bottom:1px solid #f1f5f9; color:#6c757d;">${when}</td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function formatNullable(val) {
    if (val === null || val === undefined || val === '') return '-';
    return val;
}

function getActivityIcon(activityType) {
    switch(activityType) {
        case 'created': return 'plus-circle';
        case 'updated': return 'edit';
        case 'status_change': return 'sync-alt';
        case 'note': return 'sticky-note';
        case 'meeting': return 'calendar-alt';
        case 'call': return 'phone';
        case 'email': return 'envelope';
        default: return 'circle';
    }
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatDateTime(date) {
    return date.toLocaleString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDateTimeSafe(val) {
    if (!val) return '-';
    try {
        const d = new Date(val);
        return formatDateTime(d);
    } catch (e) {
        return val;
    }
}

function parseNumber(val) {
    if (val === undefined || val === null || val === '') return undefined;
    const n = Number(val);
    return isNaN(n) ? undefined : n;
}

function parseIntSafe(val) {
    if (val === undefined || val === null || val === '') return undefined;
    const n = parseInt(val, 10);
    return isNaN(n) ? undefined : n;
}

// Tab navigation
function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Update active tab button
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#495057';
                btn.style.border = '2px solid #dee2e6';
            });
            
            button.classList.add('active');
            button.style.background = '#0d6efd';
            button.style.color = 'white';
            button.style.border = 'none';
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
        });
    });
}

async function loadActiveUsers() {
    try {
        const res = await fetch('/api/users/active');
        const data = await res.json();
        if (data.success && data.users) {
            activeUsers = data.users;
            populateAssignees();
        }
    } catch (e) {
        console.error('Failed to load active users', e);
    }
}

function populateAssignees() {
    const sel = document.getElementById('modalAssignedTo');
    if (!sel) return;
    sel.innerHTML = '<option value="">Unassigned</option>';
    activeUsers.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.full_name || u.username;
        sel.appendChild(opt);
    });
    if (leadData && leadData.assigned_to) {
        sel.value = leadData.assigned_to;
    }
}

// Load configured dropdowns from settings API
async function loadConfiguredDropdownsDetail() {
    try {
        const response = await fetch('/api/settings/lead-settings', {
            method: 'GET',
            credentials: 'include',
            headers: {'Accept': 'application/json'}
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.settings) {
                // Map of settings to select elements
                const dropdownMap = {
                    statuses: 'newStatus',
                    prospect: 'modalProspect',
                    purpose_of_meeting: 'modalPurpose',
                    communication_method: 'modalCommMethod'
                };
                
                Object.entries(dropdownMap).forEach(([settingKey, selectId]) => {
                    const select = document.getElementById(selectId);
                    if (select && data.settings[settingKey]) {
                        const items = data.settings[settingKey];
                        const currentValue = select.value;
                        let placeholder = 'Select Option';
                        if (selectId === 'newStatus') placeholder = 'Select Status';
                        else if (selectId === 'modalProspect') placeholder = 'Select Prospect';
                        else if (selectId === 'modalPurpose') placeholder = 'Select Purpose';
                        else if (selectId === 'modalCommMethod') placeholder = 'Select Communication Method';
                        
                        select.innerHTML = `<option value="">${placeholder}</option>`;
                        
                        items.forEach(item => {
                            if (item && item.name) {
                                const opt = document.createElement('option');
                                opt.value = item.name;
                                opt.textContent = item.name;
                                select.appendChild(opt);
                            }
                        });
                        
                        // Restore selection if it still exists
                        if (currentValue) {
                            select.value = currentValue;
                            if (!select.value) {
                                select.value = '';
                            }
                        }
                    }
                });
            }
        }
    } catch (err) {
        console.warn('Failed to load configured dropdowns:', err);
    }
}

// Auto-calculate lead percentage in modal based on selected status
async function autoCalculateLeadPercentageModal() {
    const statusSelect = document.getElementById('newStatus');
    const percentageInput = document.getElementById('modalLeadPct');
    
    if (!statusSelect || !percentageInput) return;
    
    const status = statusSelect.value;
    const currentPercentage = percentageInput.value; // Store current value
    
    if (!status) {
        percentageInput.value = '';
        return;
    }
    
    try {
        const response = await fetch('/api/settings/lead-settings', {
            method: 'GET',
            credentials: 'include',
            headers: {'Accept': 'application/json'}
        });
        if (response.ok) {
            const data = await response.json();
            if (data.settings && data.settings.status_percentages) {
                const mappings = data.settings.status_percentages;
                // Agar status ke liye mapping hai to use karo, otherwise previous value rakho
                if (status in mappings) {
                    percentageInput.value = mappings[status];
                } else {
                    // Mapping nahi mila, previous percentage rakho
                    percentageInput.value = currentPercentage;
                }
            }
        }
    } catch (err) {
        console.warn('Failed to auto-calculate percentage in modal:', err);
    }
}

// --- Update Modal Financial Fields Auto-Calculation ---
function parseFloatOrZero(val) {
    const n = parseFloat(val);
    return isNaN(n) ? 0 : n;
}
function updateModalFinancialFields() {
    const approxValue = parseFloatOrZero(document.getElementById('modalApprox')?.value);
    const closingAmount = parseFloatOrZero(document.getElementById('modalClosing')?.value);
    const marginPercent = parseFloatOrZero(document.getElementById('modalMarginPercent')?.value) / 100;
    const receivedAmount = parseFloatOrZero(document.getElementById('modalReceivedAmount')?.value);

    // Negotiated Value = Approx Value  Closing Amount
    const negotiatedValue = approxValue - closingAmount;
    if (document.getElementById('modalNegotiated')) {
        document.getElementById('modalNegotiated').value = negotiatedValue >= 0 ? negotiatedValue.toFixed(2) : '';
    }
    // Gross Margin Amount = Approx Value * Margin %
    const grossMarginAmount = approxValue * marginPercent;
    if (document.getElementById('modalGrossMarginAmount')) {
        document.getElementById('modalGrossMarginAmount').value = grossMarginAmount ? grossMarginAmount.toFixed(2) : '';
    }
    // Net Margin Amount = Closing Amount * Margin %
    const netMarginAmount = closingAmount * marginPercent;
    if (document.getElementById('modalNetMarginAmount')) {
        document.getElementById('modalNetMarginAmount').value = netMarginAmount ? netMarginAmount.toFixed(2) : '';
    }
    // Balance Amount = Closing Amount  Received Amount
    const balanceAmount = closingAmount - receivedAmount;
    if (document.getElementById('modalBalanceAmount')) {
        document.getElementById('modalBalanceAmount').value = balanceAmount >= 0 ? balanceAmount.toFixed(2) : '';
    }
}
function setupModalFinancialFieldAutomation() {
    const ids = ['modalApprox', 'modalClosing', 'modalMarginPercent', 'modalReceivedAmount'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', updateModalFinancialFields);
        }
    });
}
document.addEventListener('DOMContentLoaded', setupModalFinancialFieldAutomation);

// Status modal functions
function openStatusModal() {
    if (!leadData) return;
    // Load configured dropdowns before opening
    loadConfiguredDropdownsDetail();
    // Prefill fields with current data
    document.getElementById('newStatus').value = leadData.lead_status || '';
    document.getElementById('modalCommMethod').value = leadData.method_of_communication || '';
    document.getElementById('modalPurpose').value = leadData.purpose_of_meeting || '';
    const assignSelect = document.getElementById('modalAssignedTo');
    if (assignSelect && assignSelect.options.length === 0) {
        populateAssignees();
    }
    if (assignSelect) {
        assignSelect.value = leadData.assigned_to || '';
    }
    document.getElementById('modalCustomer').value = leadData.customer_name || '';
    document.getElementById('modalDesignationCustomer').value = leadData.designation_customer || '';
    document.getElementById('modalEmail').value = leadData.email_id || '';
    document.getElementById('modalPhone').value = leadData.contact_no || '';
    document.getElementById('modalLinkedIn').value = leadData.linkedin_profile || '';
    document.getElementById('modalNextFollow').value = leadData.next_follow_up_date ? leadData.next_follow_up_date.split('T')[0] : '';
    document.getElementById('modalProspect').value = leadData.prospect || '';
    document.getElementById('modalApprox').value = leadData.approx_value || '';
    document.getElementById('modalNegotiated').value = leadData.negotiated_value || '';
    document.getElementById('modalClosing').value = leadData.closing_amount || '';
    document.getElementById('modalLeadPct').value = leadData.lead_percentage || '';
    document.getElementById('modalMeetingOutcome').value = leadData.meeting_outcome || '';
    document.getElementById('modalDiscussion').value = leadData.discussion_held || '';
    document.getElementById('statusRemarks').value = leadData.remarks || '';
    
    // Setup auto-calculation on status change and calculate for initial value
    const statusSelect = document.getElementById('newStatus');
    if (statusSelect) {
        statusSelect.addEventListener('change', autoCalculateLeadPercentageModal);
    }
    
    // Calculate for current status
    autoCalculateLeadPercentageModal();
    
    document.getElementById('statusModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Delete lead
async function deleteLead() {
    if (!confirm('Are you sure you want to delete this lead? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/leads/${leadId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', 'Lead deleted successfully!');
            setTimeout(() => {
                window.location.href = '/leads';
            }, 1500);
        } else {
            showNotification('error', data.detail || 'Failed to delete lead');
        }
    } catch (error) {
        console.error('Error deleting lead:', error);
        showNotification('error', 'Failed to delete lead. Please try again.');
    }
}

// Update lead (except company info)
document.getElementById('statusForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newStatus = document.getElementById('newStatus').value;
    const remarks = document.getElementById('statusRemarks').value;
    const payload = {
        lead_status: newStatus || undefined,
        method_of_communication: document.getElementById('modalCommMethod').value || undefined,
        assigned_to: parseIntSafe(document.getElementById('modalAssignedTo') ? document.getElementById('modalAssignedTo').value : ''),
        customer_name: document.getElementById('modalCustomer').value || undefined,
        designation_customer: document.getElementById('modalDesignationCustomer').value || undefined,
        email_id: document.getElementById('modalEmail').value || undefined,
        contact_no: document.getElementById('modalPhone').value || undefined,
        linkedin_profile: document.getElementById('modalLinkedIn').value || undefined,
        // Send null explicitly so backend can clear the date when user clicks clear
        next_follow_up_date: document.getElementById('modalNextFollow').value || null,
        prospect: document.getElementById('modalProspect').value || undefined,
        purpose_of_meeting: document.getElementById('modalPurpose').value || undefined,
        approx_value: parseNumber(document.getElementById('modalApprox').value),
        negotiated_value: parseNumber(document.getElementById('modalNegotiated').value),
        closing_amount: parseNumber(document.getElementById('modalClosing').value),
        lead_percentage: parseIntSafe(document.getElementById('modalLeadPct').value),
        meeting_outcome: document.getElementById('modalMeetingOutcome').value || undefined,
        discussion_held: document.getElementById('modalDiscussion').value || undefined,
        remarks: remarks || undefined
    };
    // Keep lead_owner in sync if assigned_to selected
    if (payload.assigned_to && document.getElementById('modalAssignedTo')) {
        const sel = document.getElementById('modalAssignedTo');
        const name = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';
        if (name) payload.lead_owner = name;
    }
    
    // remove undefined keys to avoid overwriting with null
    Object.keys(payload).forEach(k => payload[k] === undefined || payload[k] === '' ? delete payload[k] : null);
    
    if (Object.keys(payload).length === 0) {
        showNotification('error', 'Nothing to update');
        return;
    }
    
    try {
        const response = await fetch(`/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', 'Status updated successfully!');
            closeStatusModal();
            loadLeadData(); // Reload data
        } else {
            showNotification('error', data.detail || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        showNotification('error', 'Failed to update status. Please try again.');
    }
});

function showLoading(show) {
    // Simple loading indicator
    if (show) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.opacity = '0.5';
        });
    } else {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.opacity = '1';
        });
    }
}

function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 400px;
    `;
    
    if (type === 'success') {
        notification.style.background = '#198754';
        notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    } else if (type === 'error') {
        notification.style.background = '#dc3545';
        notification.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    } else {
        notification.style.background = '#0d6efd';
        notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
    }
    
    document.body.appendChild(notification);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.4s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    .modal-label { display:block; margin-bottom:6px; color:#495057; font-weight:600; }
    .modal-input { width:100%; padding:10px 12px; border:2px solid #dee2e6; border-radius:8px; font-size:1em; box-sizing:border-box; }
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    initTabs();
    
    // Auto-refresh every 30 seconds
    setInterval(loadLeadData, 30000);
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('statusModal');
    if (event.target === modal) {
        closeStatusModal();
    }
};
</script>

<style>
/* Fix sidebar and layout */
body {
    overflow-x: hidden !important;
    min-width: 320px;
    background-color: #f8f9fa !important;
}

.main-content {
    overflow-x: hidden !important;
    width: calc(100vw - 250px) !important;
    box-sizing: border-box;
    background-color: #f8f9fa;
}

/* Navy Blue Theme (matching your reference) */
.content-header {
    background: #0d6efd !important;
}

.btn-primary {
    background: #0d6efd !important;
}

.btn-info {
    background: #0d6efd !important;
}

.btn-danger {
    background: #dc3545 !important;
}

/* Status badges matching reference theme */
.status-badge {
    padding: 10px 20px !important;
    border-radius: 20px !important;
    font-weight: 600 !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    font-size: 1.1em !important;
}

/* Info card hover effect */
.info-card:hover {
    transform: translateY(-3px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Link styles */
a[href^="mailto:"], 
a[href^="tel:"], 
a[href^="http"] {
    color: #0d6efd !important;
    text-decoration: none !important;
    font-weight: 500 !important;
}

a[href^="mailto:"]:hover, 
a[href^="tel:"]:hover, 
a[href^="http"]:hover {
    text-decoration: underline !important;
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #0d6efd;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #0a58ca;
}

/* Responsive design */
@media (max-width: 1200px) {
    .info-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
    }
}

@media (max-width: 768px) {
    .main-content {
        padding: 10px !important;
        width: 100vw !important;
        margin-left: 0 !important;
    }
    
    .content-header h2 {
        font-size: 1.5em !important;
    }
    
    .info-grid {
        grid-template-columns: 1fr !important;
    }
    
    .info-row {
        flex-direction: column !important;
        gap: 5px !important;
    }
    
    .info-label {
        flex: none !important;
        width: 100% !important;
    }
    
    .detail-tabs {
        flex-direction: column !important;
    }
    
    .tab-btn {
        width: 100% !important;
        margin: 5px 0 !important;
    }
}

@media (max-width: 480px) {
    .content-header {
        padding: 15px !important;
    }
    
    .lead-overview > div {
        flex-direction: column !important;
        align-items: flex-start !important;
    }
    
    .modal-content {
        width: 95% !important;
        margin: 10% auto !important;
    }
}
</style>
{% endblock %}