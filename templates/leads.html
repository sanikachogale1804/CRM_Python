{% extends "base.html" %}

{% block title %}Leads | Smart CRM{% endblock %}

{% block content %}
<div class="content-container" style="margin: 0; padding: 0; width: 100%;">
    <!-- Header -->
    <div class="content-header" style="margin-bottom: 25px; padding: 20px; background: #0d6efd; border-radius: 12px; color: white; box-shadow: 0 4px 20px rgba(13, 110, 253, 0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div>
                <h2 style="margin: 0; font-weight: 700; font-size: 2rem; color: white;">
                    <i class="fas fa-chart-line" style="margin-right: 10px;"></i>
                    Leads Dashboard
                </h2>
                <div style="font-size: 1em; opacity: 0.9; margin-top: 8px;">
                    Manage and track all your sales leads in one place
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="stat-badge" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-users"></i>
                    <span>Total: <strong id="total-leads-badge">0</strong></span>
                </div>
                <div class="stat-badge" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-calendar-check"></i>
                    <span>Follow-ups: <strong id="upcoming-badge">0</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Actions Bar -->
    <div class="filter-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
        <!-- Filters -->
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <div class="filter-group" style="position: relative;">
                <div style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #0d6efd; z-index: 1;">
                    <i class="fas fa-filter"></i>
                </div>
                <select id="status-filter" class="form-select" data-setting="statuses" style="width: 180px; padding-left: 35px; background: white; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; height: 42px; color: #495057;">
                    <option value="">All Status</option>
                </select>
            </div>
            
            <div class="filter-group" style="position: relative;">
                <div style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #0d6efd; z-index: 1;">
                    <i class="fas fa-user"></i>
                </div>
                <select id="owner-filter" class="form-select" style="width: 180px; padding-left: 35px; background: white; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; height: 42px; color: #495057;">
                    <option value="">All Owners</option>
                </select>
            </div>
            
            <div class="filter-group" style="position: relative;">
                <div style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #0d6efd; z-index: 1;">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" id="search-input" placeholder="Search leads..." 
                       style="width: 250px; padding: 10px 15px 10px 40px; border-radius: 8px; border: 2px solid #dee2e6; background: white; font-size: 1em; transition: all 0.3s; color: #495057;">
            </div>
            
            <div class="filter-buttons" style="display: flex; gap: 8px;">
                <button id="apply-filters" class="btn btn-primary" style="padding: 10px 20px; font-size: 1em; background: #0d6efd; border: none; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check"></i> Apply
                </button>
                <button id="clear-filters" class="btn btn-light" style="padding: 10px 20px; font-size: 1em; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
        
        <!-- Actions -->
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/add-lead" class="btn btn-success" data-permission="leads.action.add" style="padding: 10px 20px; font-size: 1em; background: #0d6efd; border: none; border-radius: 8px; color: white; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-plus-circle"></i> Add Lead
            </a>
            
            <button id="export-btn" class="btn btn-outline-primary" data-permission="leads.action.export" style="padding: 10px 20px; font-size: 1em; border: 2px solid #0d6efd; border-radius: 8px; background: white; color: #0d6efd; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-file-export"></i> Export
            </button>
            
            <button id="toggle-columns-btn" class="btn btn-outline-secondary" style="padding: 10px 20px; font-size: 1em; border: 2px solid #6c757d; border-radius: 8px; background: white; color: #6c757d; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-cog"></i> Columns
            </button>
        </div>
    </div>

    <!-- Column Toggle Modal -->
    <div id="columns-modal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(13, 110, 253, 0.8); align-items: center; justify-content: center;">
        <div class="modal-content" style="background-color: white; margin: auto; padding: 0; width: 90%; max-width: 500px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; max-height: 80vh; display: flex; flex-direction: column; border: 2px solid #dee2e6;">
            <div style="padding: 20px 25px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; background: #0d6efd; border-radius: 16px 16px 0 0; color: white;">
                <h3 style="margin: 0; font-size: 1.2em; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-columns"></i>
                    Select Columns
                </h3>
                <button onclick="closeColumnsModal()" style="background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-size: 1.2em; transition: background 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 20px 25px; overflow-y: auto; flex-grow: 1;">
                <div id="columns-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <!-- Columns will be populated by JavaScript -->
                </div>
            </div>
            <div style="padding: 20px 25px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; gap: 10px; background: #f8f9fa;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="selectAllColumns()" class="btn btn-sm" style="padding: 8px 16px; font-size: 0.9em; background: #0d6efd; color: white; border: none; border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button onclick="deselectAllColumns()" class="btn btn-sm" style="padding: 8px 16px; font-size: 0.9em; background: #6c757d; color: white; border: none; border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="far fa-square"></i> Deselect All
                    </button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeColumnsModal()" class="btn btn-sm" style="padding: 8px 16px; font-size: 0.9em; background: white; color: #6c757d; border: 1px solid #dee2e6; border-radius: 6px;">
                        Cancel
                    </button>
                    <button onclick="applyColumnSelection()" class="btn btn-sm" style="padding: 8px 20px; font-size: 0.9em; background: #0d6efd; color: white; border: none; border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-check"></i> Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="kpi-card" style="background: white; padding: 25px; border-radius: 16px; color: #495057; box-shadow: 0 6px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="background: #0d6efd; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-users" style="font-size: 1.8em; color: white;"></i>
                </div>
                <div style="flex-grow: 1;">
                    <div style="font-size: 1.1em; font-weight: 600; color: #495057; margin-bottom: 5px;">Total Leads</div>
                    <div id="total-leads" style="font-size: 2.5rem; font-weight: 700; line-height: 1.2; color: #0d6efd;">0</div>
                    <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">Across all status</div>
                </div>
            </div>
        </div>
        
        <div class="kpi-card" style="background: white; padding: 25px; border-radius: 16px; color: #495057; box-shadow: 0 6px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="background: #0d6efd; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-calendar-check" style="font-size: 1.8em; color: white;"></i>
                </div>
                <div style="flex-grow: 1;">
                    <div style="font-size: 1.1em; font-weight: 600; color: #495057; margin-bottom: 5px;">Upcoming Follow-ups</div>
                    <div id="upcoming-followups" style="font-size: 2.5rem; font-weight: 700; line-height: 1.2; color: #0d6efd;">0</div>
                    <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">Within next {{ follow_up_days }} days</div>
                </div>
            </div>
        </div>
        
        <div class="kpi-card" style="background: white; padding: 25px; border-radius: 16px; color: #495057; box-shadow: 0 6px 20px rgba(0,0,0,0.08); border: 1px solid #dee2e6;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="background: #0d6efd; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-chart-line" style="font-size: 1.8em; color: white;"></i>
                </div>
                <div style="flex-grow: 1;">
                    <div style="font-size: 1.1em; font-weight: 600; color: #495057; margin-bottom: 5px;">New This Month</div>
                    <div id="new-this-month" style="font-size: 2.5rem; font-weight: 700; line-height: 1.2; color: #0d6efd;">0</div>
                    <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">Current month leads</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leads Table -->
    <div class="leads-table-wrapper" style="background: white; border-radius: 16px; box-shadow: 0 6px 25px rgba(0,0,0,0.08); padding: 25px; margin-top: 10px; border: 1px solid #dee2e6;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-weight: 700; font-size: 1.3em; color: #495057; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-list"></i>
                    <span>Leads</span>
                    <span id="leads-count" style="background: #0d6efd; color: white; padding: 6px 14px; border-radius: 20px; font-size: 1em;">0</span>
                </div>
                <div id="selected-columns-info" style="font-size: 1em; color: #0d6efd; padding: 8px 14px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 20px; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-columns"></i>
                    <span>Showing all columns</span>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; font-size: 1em; color: #6c757d;">
                    <i class="fas fa-list-ol"></i>
                    <span>Show:</span>
                    <select id="page-limit" class="form-select" style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; font-size: 1em; min-width: 80px; color: #495057;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>per page</span>
                </div>
            </div>
        </div>
        
        <div style="overflow-x: auto; border: 2px solid #dee2e6; border-radius: 12px;">
            <table class="leads-table" id="leads-table" style="border-collapse: separate; border-spacing: 0; width: 100%; min-width: 4200px; font-size: 1em;">
                <thead>
                    <tr>
                        <!-- Navy Blue Theme Headers (matching sidebar) -->
                        <th data-column="lead_id" class="sticky-col" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-right: 2px solid #0a58ca; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-hashtag"></i>
                                <span>Lead ID</span>
                            </div>
                        </th>
                        <th data-column="lead_date" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar"></i>
                                <span>Lead Date</span>
                            </div>
                        </th>
                        <th data-column="lead_source" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-source"></i>
                                <span>Source</span>
                            </div>
                        </th>
                        <th data-column="lead_type" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-tag"></i>
                                <span>Type</span>
                            </div>
                        </th>
                        <th data-column="lead_owner" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user-tie"></i>
                                <span>Owner</span>
                            </div>
                        </th>
                        <th data-column="staff_location" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Staff Location</span>
                            </div>
                        </th>
                        <th data-column="designation" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-briefcase"></i>
                                <span>Designation</span>
                            </div>
                        </th>
                        <th data-column="company_name" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-building"></i>
                                <span>Company</span>
                            </div>
                        </th>
                        <th data-column="industry_type" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-industry"></i>
                                <span>Industry</span>
                            </div>
                        </th>
                        <th data-column="sub_industry" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sitemap"></i>
                                <span>Sub Industry</span>
                            </div>
                        </th>
                        <th data-column="system" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-cogs"></i>
                                <span>System</span>
                            </div>
                        </th>
                        <th data-column="project_amc" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-project-diagram"></i>
                                <span>Project/AMC</span>
                            </div>
                        </th>
                        <th data-column="state" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>State</span>
                            </div>
                        </th>
                        <th data-column="district" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-map-pin"></i>
                                <span>District</span>
                            </div>
                        </th>
                        <th data-column="city" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-city"></i>
                                <span>City</span>
                            </div>
                        </th>
                        <th data-column="pin_code" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-mail-bulk"></i>
                                <span>Pin Code</span>
                            </div>
                        </th>
                        <th data-column="full_address" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-address-card"></i>
                                <span>Address</span>
                            </div>
                        </th>
                        <th data-column="company_website" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-globe"></i>
                                <span>Website</span>
                            </div>
                        </th>
                        <th data-column="company_linkedin_link" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fab fa-linkedin"></i>
                                <span>Company LinkedIn</span>
                            </div>
                        </th>
                        <th data-column="gstin" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-invoice"></i>
                                <span>GSTIN</span>
                            </div>
                        </th>
                        <th data-column="customer_name" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user"></i>
                                <span>Customer</span>
                            </div>
                        </th>
                        <th data-column="designation_customer" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-id-card"></i>
                                <span>Cust. Designation</span>
                            </div>
                        </th>
                        <th data-column="contact_no" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-phone"></i>
                                <span>Contact No</span>
                            </div>
                        </th>
                        <th data-column="email_id" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-envelope"></i>
                                <span>Email</span>
                            </div>
                        </th>
                        <th data-column="linkedin_profile" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fab fa-linkedin-in"></i>
                                <span>LinkedIn</span>
                            </div>
                        </th>
                        <th data-column="method_of_communication" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-comments"></i>
                                <span>Comm Method</span>
                            </div>
                        </th>
                        <th data-column="lead_status" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-chart-bar"></i>
                                <span>Status</span>
                            </div>
                        </th>
                        <th data-column="purpose_of_meeting" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-bullhorn"></i>
                                <span>Purpose of Meeting</span>
                            </div>
                        </th>
                        <th data-column="meeting_outcome" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-handshake"></i>
                                <span>Meeting Outcome</span>
                            </div>
                        </th>
                        <th data-column="discussion_held" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-comment-dots"></i>
                                <span>Discussion</span>
                            </div>
                        </th>
                        <th data-column="remarks" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sticky-note"></i>
                                <span>Remarks</span>
                            </div>
                        </th>
                        <th data-column="next_follow_up_date" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar-check"></i>
                                <span>Next Follow-up</span>
                            </div>
                        </th>
                        <th data-column="prospect" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-eye"></i>
                                <span>Prospect</span>
                            </div>
                        </th>
                        <th data-column="payment_term" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <span>Payment Term</span>
                            </div>
                        </th>
                        <th data-column="approx_value" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-rupee-sign"></i>
                                <span>Approx Value</span>
                            </div>
                        </th>
                        <th data-column="negotiated_value" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-handshake"></i>
                                <span>Negotiated Value</span>
                            </div>
                        </th>
                        <th data-column="closing_amount" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-check-circle"></i>
                                <span>Closing Amount</span>
                            </div>
                        </th>
                        <th data-column="margin_percent" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-percent"></i>
                                <span>Margin %</span>
                            </div>
                        </th>
                        <th data-column="gross_margin_amount" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-coins"></i>
                                <span>Gross Margin Amount</span>
                            </div>
                        </th>
                        <th data-column="net_margin_amount" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-wallet"></i>
                                <span>Net Margin Amount</span>
                            </div>
                        </th>
                        <th data-column="received_amount" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Received Amount</span>
                            </div>
                        </th>
                        <th data-column="balance_amount" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-balance-scale"></i>
                                <span>Balance Amount</span>
                            </div>
                        </th>
                        <th data-column="lead_closer_date" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar-check"></i>
                                <span>Lead Closer Date</span>
                            </div>
                        </th>
                        <th data-column="expected_lead_closer_month" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Expected Lead Closer Month</span>
                            </div>
                        </th>
                        <th data-column="lead_aging" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-clock"></i>
                                <span>Aging (Days)</span>
                            </div>
                        </th>
                        <th data-column="lead_percentage" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-percentage"></i>
                                <span>Lead %</span>
                            </div>
                        </th>
                        <th data-column="created_by_name" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user-plus"></i>
                                <span>Created By</span>
                            </div>
                        </th>
                        <th data-column="assigned_to_name" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user-check"></i>
                                <span>Assigned To</span>
                            </div>
                        </th>
                        <th data-column="created_at" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-plus-square"></i>
                                <span>Created At</span>
                            </div>
                        </th>
                        <th data-column="updated_at" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sync-alt"></i>
                                <span>Updated At</span>
                            </div>
                        </th>
                        <th class="sticky-col-right" style="background: #0d6efd; color: white; padding: 18px 14px; text-align: left; font-weight: 600; border-left: 2px solid #0a58ca; border-bottom: 2px solid #0a58ca; font-size: 1.1em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-cogs"></i>
                                <span>Actions</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="leads-tbody">
                    <!-- Data populated by JS -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #dee2e6;">
            <div style="font-size: 1.1em; color: #495057; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-alt"></i>
                <span>Page <span id="current-page" style="font-weight: 700; color: #0d6efd;">1</span> of <span id="total-pages" style="font-weight: 700; color: #0d6efd;">1</span></span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="first-page" class="btn btn-sm" style="padding: 10px 14px; background: #0d6efd; color: white; border: none; border-radius: 8px; min-width: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.1em;" disabled>
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button id="prev-page" class="btn btn-sm" style="padding: 10px 14px; background: #0d6efd; color: white; border: none; border-radius: 8px; min-width: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.1em;" disabled>
                    <i class="fas fa-angle-left"></i>
                </button>
                <div style="display: flex; align-items: center; gap: 10px; margin: 0 15px;">
                    <span style="font-size: 1em; color: #495057;">Go to:</span>
                    <input type="number" id="page-input" min="1" value="1" 
                           style="width: 90px; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1.1em; text-align: center; background: white; color: #495057;">
                </div>
                <button id="next-page" class="btn btn-sm" style="padding: 10px 14px; background: #0d6efd; color: white; border: none; border-radius: 8px; min-width: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.1em;">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button id="last-page" class="btn btn-sm" style="padding: 10px 14px; background: #0d6efd; color: white; border: none; border-radius: 8px; min-width: 44px; display: flex; align-items: center; justify-content: center; font-size: 1.1em;">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
// Global data and state
let leadsData = [];
let filteredData = [];
let sortColumn = 'updated_at';
let sortAsc = false;
let currentPage = 1;
let pageLimit = 20;
let totalPages = 1;
let totalLeads = 0;
let filters = {
    status: '',
    owner: '',
    search: ''
};

// Store unique values for dynamic filters
let availableStatuses = new Set();
let availableOwners = new Set();

// Column configuration
const allColumns = [
    { id: 'lead_id', name: 'Lead ID', visible: true, sticky: true },
    { id: 'lead_date', name: 'Lead Date', visible: true },
    { id: 'lead_source', name: 'Source', visible: true },
    { id: 'lead_type', name: 'Type', visible: true },
    { id: 'lead_owner', name: 'Owner', visible: true },
    { id: 'staff_location', name: 'Staff Location', visible: true },
    { id: 'designation', name: 'Designation', visible: true },
    { id: 'company_name', name: 'Company', visible: true },
    { id: 'industry_type', name: 'Industry', visible: true },
    { id: 'sub_industry', name: 'Sub Industry', visible: true },
    { id: 'system', name: 'System', visible: true },
    { id: 'project_amc', name: 'Project/AMC', visible: true },
    { id: 'state', name: 'State', visible: true },
    { id: 'district', name: 'District', visible: true },
    { id: 'city', name: 'City', visible: true },
    { id: 'pin_code', name: 'Pin Code', visible: true },
    { id: 'full_address', name: 'Address', visible: true },
    { id: 'company_website', name: 'Website', visible: true },
    { id: 'company_linkedin_link', name: 'Company LinkedIn', visible: true },
    { id: 'gstin', name: 'GSTIN', visible: true },
    { id: 'customer_name', name: 'Customer', visible: true },
    { id: 'designation_customer', name: 'Cust. Designation', visible: true },
    { id: 'contact_no', name: 'Contact No', visible: true },
    { id: 'email_id', name: 'Email', visible: true },
    { id: 'linkedin_profile', name: 'LinkedIn', visible: true },
    { id: 'method_of_communication', name: 'Comm Method', visible: true },
    { id: 'lead_status', name: 'Status', visible: true },
    { id: 'purpose_of_meeting', name: 'Purpose of Meeting', visible: true },
    { id: 'meeting_outcome', name: 'Meeting Outcome', visible: true },
    { id: 'discussion_held', name: 'Discussion', visible: true },
    { id: 'remarks', name: 'Remarks', visible: true },
    { id: 'next_follow_up_date', name: 'Next Follow-up', visible: true },
    { id: 'prospect', name: 'Prospect', visible: true },
    { id: 'payment_term', name: 'Payment Term', visible: true },
    { id: 'approx_value', name: 'Approx Value', visible: true },
    { id: 'negotiated_value', name: 'Negotiated Value', visible: true },
    { id: 'closing_amount', name: 'Closing Amount', visible: true },
    { id: 'margin_percent', name: 'Margin %', visible: true },
    { id: 'gross_margin_amount', name: 'Gross Margin Amount', visible: true },
    { id: 'net_margin_amount', name: 'Net Margin Amount', visible: true },
    { id: 'received_amount', name: 'Received Amount', visible: true },
    { id: 'balance_amount', name: 'Balance Amount', visible: true },
    { id: 'lead_closer_date', name: 'Lead Closer Date', visible: true },
    { id: 'expected_lead_closer_month', name: 'Expected Lead Closer Month', visible: true },
    { id: 'lead_aging', name: 'Aging (Days)', visible: true },
    { id: 'lead_percentage', name: 'Lead %', visible: true },
    { id: 'created_by_name', name: 'Created By', visible: true },
    { id: 'assigned_to_name', name: 'Assigned To', visible: true },
    { id: 'created_at', name: 'Created At', visible: true },
    { id: 'updated_at', name: 'Updated At', visible: true }
];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Fix sidebar issue by controlling container width
    document.querySelector('.main-content').style.overflowX = 'hidden';
    document.querySelector('.main-content').style.width = 'calc(100vw - 250px)';
    
    initializeColumns();
    fetchLeads();
    setupEventListeners();
});

// Initialize columns from localStorage or defaults
function initializeColumns() {
    const savedColumns = localStorage.getItem('leadTableColumns');
    if (savedColumns) {
        const parsed = JSON.parse(savedColumns);
        allColumns.forEach(col => {
            const savedCol = parsed.find(c => c.id === col.id);
            if (savedCol) col.visible = savedCol.visible;
        });
    }
    updateColumnVisibility();
    updateSelectedColumnsInfo();
}

// Update column visibility in table
function updateColumnVisibility() {
    const headers = document.querySelectorAll('#leads-table th');
    const cells = document.querySelectorAll('#leads-table td');
    
    headers.forEach((header, index) => {
        if (index < allColumns.length) {
            const column = allColumns[index];
            header.style.display = column.visible ? '' : 'none';
        }
    });
    
    // Also hide corresponding data cells
    document.querySelectorAll('#leads-table tbody tr').forEach(row => {
        const rowCells = row.querySelectorAll('td');
        rowCells.forEach((cell, index) => {
            if (index < allColumns.length) {
                const column = allColumns[index];
                cell.style.display = column.visible ? '' : 'none';
            }
        });
    });
}

// Update selected columns info
function updateSelectedColumnsInfo() {
    const visibleCount = allColumns.filter(col => col.visible).length;
    document.getElementById('selected-columns-info').innerHTML = 
        `<i class="fas fa-columns"></i>
         <span>Showing ${visibleCount} of ${allColumns.length} columns</span>`;
}

// Update filter options with available data
function updateFilterOptions() {
    // Update status filter
    const statusFilter = document.getElementById('status-filter');
    // Clear existing options except first
    while (statusFilter.options.length > 1) {
        statusFilter.remove(1);
    }
    
    // Add unique statuses from data
    Array.from(availableStatuses).sort().forEach(status => {
        if (status && status.trim()) {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusFilter.appendChild(option);
        }
    });
    
    // Update owner filter
    const ownerFilter = document.getElementById('owner-filter');
    // Clear existing options except first
    while (ownerFilter.options.length > 1) {
        ownerFilter.remove(1);
    }
    
    // Add unique owners from data
    Array.from(availableOwners).sort().forEach(owner => {
        if (owner && owner.trim()) {
            const option = document.createElement('option');
            option.value = owner;
            option.textContent = owner;
            ownerFilter.appendChild(option);
        }
    });
}

// Fetch leads from API with pagination
async function fetchLeads(page = 1) {
    try {
        currentPage = page;
        
        // Build query parameters
        const params = new URLSearchParams({
            page: page,
            limit: pageLimit,
            ...(filters.status && { status: filters.status }),
            ...(filters.owner && { owner: filters.owner }),
            ...(filters.search && { search: filters.search })
        });

        const res = await fetch(`/api/leads?${params}`);
        const data = await res.json();
        
        if(data.success){
            leadsData = data.data.map(lead => {
                // Format data for display
                lead.formatted_approx_value = formatCurrency(lead.approx_value);
                lead.formatted_negotiated_value = formatCurrency(lead.negotiated_value);
                lead.formatted_closing_amount = formatCurrency(lead.closing_amount);
                lead.formatted_lead_date = formatDate(lead.lead_date);
                lead.formatted_next_follow_up_date = formatDate(lead.next_follow_up_date);
                lead.formatted_created_at = formatDateTime(lead.created_at);
                lead.formatted_updated_at = formatDateTime(lead.updated_at);
                
                // Calculate Aging if not present
                if(!lead.lead_aging && lead.created_at){
                    const created = new Date(lead.created_at);
                    const today = new Date();
                    lead.lead_aging = Math.floor((today - created) / (1000*60*60*24));
                }
                
                // Add percentage display (show 0% explicitly)
                lead.lead_percentage_display = (typeof lead.lead_percentage === 'number') ? `${lead.lead_percentage}%` : '-';
                
                // Add symbols for display
                lead.symbol_lead_source = getLeadSourceSymbol(lead.lead_source);
                lead.symbol_lead_type = getLeadTypeSymbol(lead.lead_type);
                lead.symbol_lead_status = getStatusSymbol(lead.lead_status);
                
                // Collect unique values for filters
                if (lead.lead_status && lead.lead_status.trim()) {
                    availableStatuses.add(lead.lead_status);
                }
                if (lead.lead_owner && lead.lead_owner.trim()) {
                    availableOwners.add(lead.lead_owner);
                }
                
                return lead;
            });
            
            filteredData = [...leadsData];
            totalLeads = data.pagination.total;
            totalPages = data.pagination.pages || 1;
            
            // Update filter options with available data
            updateFilterOptions();
            
            updateKPIs();
            renderTable();
            updatePagination();
            updateStats();
        }
    } catch(err) { 
        console.error('Error fetching leads:', err);
        showError('Failed to load leads');
    }
}

// Get symbol for lead source
function getLeadSourceSymbol(source) {
    const symbols = {
        'Website': '',
        'Referral': '',
        'Social Media': '',
        'Email': '',
        'Call': '',
        'Event': '',
        'Other': ''
    };
    return symbols[source] || '';
}

// Get symbol for lead type
function getLeadTypeSymbol(type) {
    const symbols = {
        'Hot': '',
        'Warm': '',
        'Cold': '',
        'Existing': ''
    };
    return symbols[type] || '';
}

// Get symbol for status
function getStatusSymbol(status) {
    const symbols = {
        'New': '',
        'Contacted': '',
        'Qualified': '',
        'Proposal Sent': '',
        'Negotiation': '',
        'Closed Won': '',
        'Closed Lost': ''
    };
    return symbols[status] || '';
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN');
    } catch {
        return dateString;
    }
}

// Format date-time for display
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return '-';
    try {
        const date = new Date(dateTimeString);
        return date.toLocaleString('en-IN');
    } catch {
        return dateTimeString;
    }
}

// Format currency
function formatCurrency(value) {
    if (!value || value === 0) return '0';
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

// Create clickable link
function createLink(url, text) {
    if (!url) return '-';
    if (!url.startsWith('http')) url = 'https://' + url;
    return `<a href="${url}" target="_blank" class="text-link" style="color: #0d6efd; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-size: 1.1em;">
        <i class="fas fa-external-link-alt" style="font-size: 0.9em;"></i>
        ${text || url}
    </a>`;
}

// Create email link
function createEmailLink(email) {
    if (!email) return '-';
    return `<a href="mailto:${email}" class="email-link" style="color: #0d6efd; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-size: 1.1em;">
        <i class="fas fa-envelope" style="font-size: 0.9em;"></i>
        ${email}
    </a>`;
}

// Create phone link
function createPhoneLink(phone) {
    if (!phone) return '-';
    return `<a href="tel:${phone}" class="phone-link" style="color: #0d6efd; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-size: 1.1em;">
        <i class="fas fa-phone" style="font-size: 0.9em;"></i>
        ${phone}
    </a>`;
}

// Update KPI cards
function updateKPIs() {
    // Total leads
    const total = totalLeads;
    document.getElementById('total-leads').textContent = total;
    document.getElementById('total-leads-badge').textContent = total;
    
    // Upcoming follow-ups
    const upcoming = leadsData.filter(lead => {
        if(!lead.next_follow_up_date) return false;
        const followupDate = new Date(lead.next_follow_up_date);
        const today = new Date();
        const next7Days = new Date();
        next7Days.setDate(today.getDate() + 7);
        return followupDate >= today && followupDate <= next7Days;
    }).length;
    document.getElementById('upcoming-followups').textContent = upcoming;
    document.getElementById('upcoming-badge').textContent = upcoming;
    
    // New this month
    const thisMonth = leadsData.filter(lead => {
        if(!lead.created_at) return false;
        const created = new Date(lead.created_at);
        const today = new Date();
        return created.getMonth() === today.getMonth() && 
               created.getFullYear() === today.getFullYear();
    }).length;
    document.getElementById('new-this-month').textContent = thisMonth;
}

// Render table with all columns
function renderTable() {
    const tbody = document.getElementById('leads-tbody');
    const countSpan = document.getElementById('leads-count');
    
    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="${allColumns.length + 1}" style="text-align: center; padding: 60px 20px; border: 1px solid #dee2e6;">
                    <div style="font-size: 1.4em; color: #6c757d; margin-bottom: 15px;">
                        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px; color: #dee2e6;"></i><br>
                        No leads found matching your criteria
                    </div>
                    <div style="color: #95a5a6; font-size: 1.1em; margin-bottom: 20px;">
                        Try adjusting your filters or add a new lead
                    </div>
                    {% if user.permissions.can_create_leads %}
                    <a href="/add-lead" class="btn" style="padding: 12px 28px; background: #0d6efd; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; font-size: 1.1em;">
                        <i class="fas fa-plus"></i> Add Your First Lead
                    </a>
                    {% endif %}
                </td>
            </tr>
        `;
        countSpan.textContent = '0';
        return;
    }
    
    // Apply sorting
    const sortedData = [...filteredData].sort((a, b) => {
        if (!sortColumn) return 0;
        
        let valA = a[sortColumn];
        let valB = b[sortColumn];
        
        // Handle null/undefined values
        if (valA == null) return 1;
        if (valB == null) return -1;
        
        // Handle numeric values
        if (sortColumn.includes('value') || sortColumn.includes('aging') || sortColumn.includes('percentage')) {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
        }
        
        // Handle dates
        if (sortColumn.includes('date') || sortColumn.includes('_at')) {
            valA = new Date(valA).getTime();
            valB = new Date(valB).getTime();
        }
        
        if (valA < valB) return sortAsc ? -1 : 1;
        if (valA > valB) return sortAsc ? 1 : -1;
        return 0;
    });
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add new rows with larger text size and black font
    sortedData.forEach((lead, index) => {
        const tr = document.createElement('tr');
        tr.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
        tr.style.borderBottom = '1px solid #dee2e6';
        
        // Status badge
        const statusClass = {
            'New': 'badge bg-primary',
            'Contacted': 'badge bg-info',
            'Qualified': 'badge bg-success',
            'Proposal Sent': 'badge bg-warning',
            'Negotiation': 'badge bg-purple',
            'Closed Won': 'badge bg-success',
            'Closed Lost': 'badge bg-danger'
        }[lead.lead_status] || 'badge bg-secondary';
        
        // Build row HTML with larger font size and black color
        let rowHTML = '';
        
        // Lead ID (sticky) - NO COLOR, plain black text
        rowHTML += `<td class="sticky-col" style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'}; border-right: 2px solid #dee2e6; padding: 16px; font-weight: 700; font-size: 1.1em; color: #000000;">
            <a href="/lead-detail/${lead.lead_id}" style="color: #000000; text-decoration: none; font-size: 1.2em;">
                ${lead.lead_id}
            </a>
        </td>`;
        
        // Lead Date - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="font-family: monospace; font-size: 1.1em; color: #000000;">
                 ${lead.formatted_lead_date}
            </span>
        </td>`;
        
        // Lead Source - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px;">
                ${lead.symbol_lead_source} ${lead.lead_source || '-'}
            </span>
        </td>`;
        
        // Lead Type - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f8f9fa; border-radius: 4px; font-size: 1.1em;">
                ${lead.symbol_lead_type} ${lead.lead_type || '-'}
            </span>
        </td>`;
        
        // Lead Owner - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px; font-size: 1.1em;">
                 ${lead.lead_owner || '-'}
            </span>
        </td>`;
        // Staff Location - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px; font-size: 1.1em;">
                 ${lead.staff_location || '-'}
            </span>
        </td>`;
        
        // Designation - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 1.1em;">
                 ${lead.designation || '-'}
            </span>
        </td>`;
        
        // Company Name - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-weight: 600; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px;">
                 ${lead.company_name || '-'}
            </span>
        </td>`;
        
        // Industry Type - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px;">
                 ${lead.industry_type || '-'}
            </span>
        </td>`;
        
        // Sub Industry - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            ${lead.sub_industry || '-'}
        </td>`;
        
        // System - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 1.1em;">
                 ${lead.system || '-'}
            </span>
        </td>`;
        
        // Project/AMC - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            ${lead.project_amc || '-'}
        </td>`;
        
        // State - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px;">
                 ${lead.state || '-'}
            </span>
        </td>`;
        
        // District - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
             ${lead.district || '-'}
        </td>`;
        
        // City - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
             ${lead.city || '-'}
        </td>`;
        // Pin Code - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="font-family: monospace; background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 1.1em;">
                 ${lead.pin_code || '-'}
            </span>
        </td>`;
        
        // Full Address - Keep wrap for this field only, BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; max-width: 250px !important; min-width: 200px; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; font-size: 1.1em; color: #000000;">
            ${lead.full_address || '-'}
        </td>`;
        
        // Company Website - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em;">
            ${createLink(lead.company_website, 'Website')}
        </td>`;
        
        // Company LinkedIn - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em;">
            ${createLink(lead.company_linkedin_link, 'LinkedIn')}
        </td>`;
        
        // GSTIN - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <code style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-family: monospace; font-size: 1.1em;">
                ${lead.gstin || '-'}
            </code>
        </td>`;
        
        // Customer Name - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-weight: 600; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px;">
                 ${lead.customer_name || '-'}
            </span>
        </td>`;
        
        // Customer Designation - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 1.1em;">
                 ${lead.designation_customer || '-'}
            </span>
        </td>`;
        
        // Contact No - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em;">
            ${createPhoneLink(lead.contact_no)}
        </td>`;
        
        // Email - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em;">
            ${createEmailLink(lead.email_id)}
        </td>`;
        
        // LinkedIn Profile - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em;">
            ${createLink(lead.linkedin_profile, 'Profile')}
        </td>`;
        
        // Communication Method - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 4px; font-size: 1.1em;">
                 ${lead.method_of_communication || 'Email'}
            </span>
        </td>`;
        
        // Status - BLACK TEXT for badge
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em;">
            <span class="${statusClass}" style="padding: 6px 14px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; font-size: 1.1em;">
                ${lead.symbol_lead_status} ${lead.lead_status || 'New'}
            </span>
        </td>`;
        
        // Purpose of Meeting - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            ${lead.purpose_of_meeting || '-'}
        </td>`;
        
        // Meeting Outcome - Keep wrap for this field only, BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; max-width: 200px; white-space: normal; font-size: 1.1em; color: #000000;">
            ${lead.meeting_outcome || '-'}
        </td>`;
        
        // Discussion Held - Keep wrap for this field only, BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; max-width: 250px !important; min-width: 200px; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; font-size: 1.1em; color: #000000;">
            ${lead.discussion_held || '-'}
        </td>`;
        
        // Remarks - Keep wrap for this field only, BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; max-width: 250px !important; min-width: 200px; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; font-size: 1.1em; color: #000000;">
            ${lead.remarks || '-'}
        </td>`;
        
        // Next Follow-up - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            ${lead.next_follow_up_date ? `
                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 4px; ${new Date(lead.next_follow_up_date) < new Date() ? 'background: #f8d7da; color: #721c24;' : 'background: #d1ecf1; color: #0c5460;'} font-size: 1.1em;">
                     ${lead.formatted_next_follow_up_date}
                </span>
            ` : '-'}
        </td>`;
        
        // Prospect - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            ${lead.prospect || '-'}
        </td>`;
        // Payment Term - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            ${lead.payment_term || '-'}
        </td>`;
        
        // Approx Value - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; text-align: right; font-weight: 600; font-size: 1.1em; color: #000000;">
            <span style="background: #0d6efd; color: white; padding: 8px 14px; border-radius: 6px; font-size: 1.1em;">
                 ${lead.formatted_approx_value}
            </span>
        </td>`;
        
        // Negotiated Value - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;">
            <span style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 1.1em;">
                 ${lead.formatted_negotiated_value}
            </span>
        </td>`;
        

        // Closing Amount - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;">
            <span style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-weight: 600; font-size: 1.1em;">
                 ${lead.formatted_closing_amount}
            </span>
        </td>`;

        // Margin %
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${lead.margin_percent != null ? lead.margin_percent + '%' : '-'}
            </span>
        </td>`;
        // Gross Margin Amount
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${lead.gross_margin_amount != null ? '' + lead.gross_margin_amount : '-'}
            </span>
        </td>`;
        // Net Margin Amount
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${lead.net_margin_amount != null ? '' + lead.net_margin_amount : '-'}
            </span>
        </td>`;
        // Received Amount
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${lead.received_amount != null ? '' + lead.received_amount : '-'}
            </span>
        </td>`;
        // Balance Amount
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; text-align: right; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${lead.balance_amount != null ? '' + lead.balance_amount : '-'}
            </span>
        </td>`;
        // Lead Closer Date (automated: if lead_percentage == 100, show today)
        let displayLeadCloserDate = '-';
        if (lead.lead_percentage == 100) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            displayLeadCloserDate = `${yyyy}-${mm}-${dd}`;
        } else if (lead.lead_closer_date) {
            displayLeadCloserDate = lead.lead_closer_date;
        }
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${displayLeadCloserDate}
            </span>
        </td>`;
        // Expected Lead Closer Month
        rowHTML += `<td style='border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;'>
            <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 4px;'>
                ${lead.expected_lead_closer_month ? lead.expected_lead_closer_month : '-'}
            </span>
        </td>`;

        // Aging - BLACK TEXT (threshold from preferences)
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000;">
            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 4px; ${lead.lead_aging > {{ aging_alert_days }} ? 'background: #f8d7da; color: #721c24;' : 'background: #d1ecf1; color: #0c5460;'} font-size: 1.1em;">
                 ${lead.lead_aging || 0} days
            </span>
        </td>`;
        
        // Lead Percentage - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; height: 50px;">
                <div class="progress" style="height: 38px; width: 140px; background: #f8f9fa; border-radius: 13px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                    <div class="progress-bar ${getProgressBarClass(lead.lead_percentage)}" 
                         style="width: ${lead.lead_percentage || 0}%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.3em; transition: width 0.6s; position: absolute; left: 0; top: 0;">
                    </div>
                    <div style="position: relative; z-index: 10; font-weight: 700; font-size: 1.3em; color: ${(lead.lead_percentage || 0) > 50 ? 'white' : '#0d6efd'}; text-shadow: ${(lead.lead_percentage || 0) > 50 ? '1px 1px 2px rgba(0,0,0,0.3)' : 'none'};">
                        ${lead.lead_percentage_display}
                    </div>
                </div>
            </div>
        </td>`;
        
        // Created By - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            <span style="color: #000000; font-size: 1.1em;"> ${lead.created_by_name || '-'}</span>
        </td>`;
        
        // Assigned To - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            <span style="color: #000000; font-size: 1.1em;"> ${lead.assigned_to_name || '-'}</span>
        </td>`;
        
        // Created At - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            <span style="color: #000000; font-family: monospace; font-size: 1.1em;"> ${lead.formatted_created_at}</span>
        </td>`;
        
        // Updated At - BLACK TEXT
        rowHTML += `<td style="border: 1px solid #dee2e6; padding: 16px; font-size: 1.1em; color: #000000; white-space: nowrap;">
            <span style="color: #000000; font-family: monospace; font-size: 1.1em;"> ${lead.formatted_updated_at}</span>
        </td>`;
        
        // Actions (sticky) - NO COLOR, just border
        rowHTML += `<td class="sticky-col-right" style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'}; border-left: 2px solid #dee2e6; padding: 16px; text-align: center;">
            <div class="action-buttons" style="display: flex; gap: 10px; justify-content: center;">
                <a href="/lead-detail/${lead.lead_id}" class="btn-action" title="View Details" 
                   style="width: 46px; height: 46px; background: #0d6efd; color: white; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; cursor: pointer; transition: all 0.3s; font-size: 1.2em;">
                    <i class="fas fa-eye"></i>
                </a>
                {% if user.permissions.can_edit_leads %}
                <a href="/edit-lead/${lead.lead_id}" class="btn-action" title="Edit Lead"
                   style="width: 46px; height: 46px; background: #0d6efd; color: white; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; cursor: pointer; transition: all 0.3s; font-size: 1.2em;">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                <button class="btn-action btn-quick-action" title="Quick Actions"
                        style="width: 46px; height: 46px; background: #0d6efd; color: white; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; font-size: 1.2em;">
                    <i class="fas fa-bolt"></i>
                </button>
            </div>
        </td>`;
        
        tr.innerHTML = rowHTML;
        
        // Apply column visibility
        const cells = tr.querySelectorAll('td');
        cells.forEach((cell, index) => {
            if (index < allColumns.length) {
                const column = allColumns[index];
                cell.style.display = column.visible ? '' : 'none';
            }
        });
        
        tbody.appendChild(tr);
    });
    
    countSpan.textContent = filteredData.length;
}

// Get progress bar class based on percentage
function getProgressBarClass(percentage) {
    if (!percentage) return 'bg-secondary';
    if (percentage >= 80) return 'bg-success';
    if (percentage >= 50) return 'bg-info';
    if (percentage >= 30) return 'bg-warning';
    return 'bg-danger';
}

// Update pagination controls
function updatePagination() {
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('page-input').value = currentPage;
    
    // Enable/disable buttons
    document.getElementById('first-page').disabled = currentPage === 1;
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages;
    document.getElementById('last-page').disabled = currentPage === totalPages;
    
    // Style disabled buttons
    const buttons = ['first-page', 'prev-page', 'next-page', 'last-page'];
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn.disabled) {
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        } else {
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        }
    });
}

// Update stats display
function updateStats() {
    const start = ((currentPage - 1) * pageLimit) + 1;
    const end = Math.min(currentPage * pageLimit, totalLeads);
    document.getElementById('leads-count').textContent = 
        `${start}-${end} of ${totalLeads}`;
}

// Setup event listeners
function setupEventListeners() {
    // Filter controls
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') applyFilters();
    });
    
    // Pagination
    document.getElementById('first-page').addEventListener('click', () => fetchLeads(1));
    document.getElementById('prev-page').addEventListener('click', () => fetchLeads(currentPage - 1));
    document.getElementById('next-page').addEventListener('click', () => fetchLeads(currentPage + 1));
    document.getElementById('last-page').addEventListener('click', () => fetchLeads(totalPages));
    document.getElementById('page-input').addEventListener('change', (e) => {
        const page = parseInt(e.target.value);
        if (page >= 1 && page <= totalPages) {
            fetchLeads(page);
        }
    });
    
    // Page limit
    document.getElementById('page-limit').addEventListener('change', (e) => {
        pageLimit = parseInt(e.target.value);
        currentPage = 1;
        fetchLeads(1);
    });
    
    // Sorting
    document.querySelectorAll('.leads-table th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
            const column = th.dataset.column;
            
            // Update sort indicators
            document.querySelectorAll('.leads-table th').forEach(h => {
                h.classList.remove('sorted-asc', 'sorted-desc');
                h.style.background = '#0d6efd';
            });
            
            if (sortColumn === column) {
                sortAsc = !sortAsc;
            } else {
                sortColumn = column;
                sortAsc = true;
            }
            
            th.classList.add(sortAsc ? 'sorted-asc' : 'sorted-desc');
            th.style.background = sortAsc ? '#0a58ca' : '#084298';
            renderTable();
        });
    });
    
    // Export button
    document.getElementById('export-btn')?.addEventListener('click', exportLeads);
    
    // Columns modal
    document.getElementById('toggle-columns-btn').addEventListener('click', openColumnsModal);
    
    // Quick action buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-quick-action')) {
            const row = e.target.closest('tr');
            const leadId = row.querySelector('.lead-id-link span').textContent;
            showQuickActions(leadId, e.target.closest('.btn-quick-action'));
        }
    });
    
    // Hover effects for action buttons
    document.addEventListener('mouseover', function(e) {
        if (e.target.closest('.btn-action')) {
            e.target.closest('.btn-action').style.transform = 'translateY(-3px)';
            e.target.closest('.btn-action').style.boxShadow = '0 5px 15px rgba(13, 110, 253, 0.3)';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.closest('.btn-action')) {
            e.target.closest('.btn-action').style.transform = 'translateY(0)';
            e.target.closest('.btn-action').style.boxShadow = 'none';
        }
    });
}

// Open columns modal
function openColumnsModal() {
    const modal = document.getElementById('columns-modal');
    const columnsList = document.getElementById('columns-list');
    
    columnsList.innerHTML = '';
    
    allColumns.forEach(column => {
        const columnDiv = document.createElement('div');
        columnDiv.className = 'column-checkbox';
        columnDiv.style.padding = '12px';
        columnDiv.style.borderRadius = '8px';
        columnDiv.style.backgroundColor = column.visible ? '#e7f1ff' : '#f8f9fa';
        columnDiv.style.transition = 'all 0.2s';
        columnDiv.style.border = '1px solid #dee2e6';
        columnDiv.innerHTML = `
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0; padding: 0;">
                <input type="checkbox" ${column.visible ? 'checked' : ''} 
                       data-column="${column.id}" 
                       style="cursor: pointer; width: 20px; height: 20px; accent-color: #0d6efd;">
                <span style="font-size: 1.1em; color: #495057; font-weight: ${column.visible ? '600' : '400'};">
                    ${getColumnIcon(column.id)} ${column.name}
                </span>
            </label>
        `;
        
        // Add hover effect
        columnDiv.addEventListener('mouseenter', () => {
            columnDiv.style.backgroundColor = '#d1e3ff';
            columnDiv.style.transform = 'translateY(-2px)';
            columnDiv.style.boxShadow = '0 4px 8px rgba(13, 110, 253, 0.1)';
        });
        columnDiv.addEventListener('mouseleave', () => {
            columnDiv.style.backgroundColor = column.visible ? '#e7f1ff' : '#f8f9fa';
            columnDiv.style.transform = 'translateY(0)';
            columnDiv.style.boxShadow = 'none';
        });
        
        columnsList.appendChild(columnDiv);
    });
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Get icon for column
function getColumnIcon(columnId) {
    const icons = {
        'lead_id': '',
        'lead_date': '',
        'lead_source': '',
        'lead_type': '',
        'lead_owner': '',
        'designation': '',
        'company_name': '',
        'industry_type': '',
        'sub_industry': '',
        'system': '',
        'project_amc': '',
        'state': '',
        'district': '',
        'city': '',
        'pin_code': '',
        'full_address': '',
        'company_website': '',
        'company_linkedin_link': '',
        'gstin': '',
        'customer_name': '',
        'designation_customer': '',
        'contact_no': '',
        'email_id': '',
        'linkedin_profile': '',
        'method_of_communication': '',
        'lead_status': '',
        'meeting_outcome': '',
        'discussion_held': '',
        'remarks': '',
        'next_follow_up_date': '',
        'prospect': '',
        'approx_value': '',
        'negotiated_value': '',
        'closing_amount': '',
        'lead_aging': '',
        'lead_percentage': '',
        'created_by_name': '',
        'assigned_to_name': '',
        'created_at': '',
        'updated_at': ''
    };
    return icons[columnId] || '';
}

// Close columns modal
function closeColumnsModal() {
    document.getElementById('columns-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Apply column selection
function applyColumnSelection() {
    const checkboxes = document.querySelectorAll('#columns-list input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        const columnId = checkbox.dataset.column;
        const column = allColumns.find(col => col.id === columnId);
        if (column) {
            column.visible = checkbox.checked;
        }
    });
    
    // Save to localStorage
    localStorage.setItem('leadTableColumns', JSON.stringify(allColumns));
    
    // Update table
    updateColumnVisibility();
    renderTable();
    updateSelectedColumnsInfo();
    
    closeColumnsModal();
}

// Select all columns
function selectAllColumns() {
    allColumns.forEach(column => column.visible = true);
    const checkboxes = document.querySelectorAll('#columns-list input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    
    // Update UI
    document.querySelectorAll('#columns-list .column-checkbox').forEach(div => {
        div.style.backgroundColor = '#e7f1ff';
        div.querySelector('span').style.fontWeight = '600';
    });
}

// Deselect all columns
function deselectAllColumns() {
    allColumns.forEach(column => column.visible = false);
    const checkboxes = document.querySelectorAll('#columns-list input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    
    // Update UI
    document.querySelectorAll('#columns-list .column-checkbox').forEach(div => {
        div.style.backgroundColor = '#f8f9fa';
        div.querySelector('span').style.fontWeight = '400';
    });
}

// Show quick actions
function showQuickActions(leadId, button) {
    // Implement quick actions menu here
    alert(`Quick actions for lead ${leadId}`);
}

// Apply filters
function applyFilters() {
    filters = {
        status: document.getElementById('status-filter').value,
        owner: document.getElementById('owner-filter').value,
        search: document.getElementById('search-input').value.trim()
    };
    currentPage = 1;
    fetchLeads(1);
}

// Clear filters
function clearFilters() {
    document.getElementById('status-filter').value = '';
    document.getElementById('owner-filter').value = '';
    document.getElementById('search-input').value = '';
    filters = { status: '', owner: '', search: '' };
    currentPage = 1;
    fetchLeads(1);
}

// Export leads
async function exportLeads() {
    try {
        const response = await fetch('/api/leads?limit=10000');
        const data = await response.json();
        
        if (data.success) {
            // Convert to CSV
            const csvRows = [];
            const headers = allColumns
                .filter(col => col.visible)
                .map(col => col.name);
            headers.push('Actions');
            csvRows.push(headers.join(','));
            
            data.data.forEach(lead => {
                const row = allColumns
                    .filter(col => col.visible)
                    .map(col => {
                        let value = lead[col.id] || '';
                        // Handle special formatting for CSV
                        if (typeof value === 'string' && value.includes(',')) {
                            value = `"${value}"`;
                        }
                        return value;
                    });
                row.push('View/Edit');
                csvRows.push(row.join(','));
            });
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `leads_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    } catch (err) {
        console.error('Export error:', err);
        showError('Failed to export leads');
    }
}

// Show error message
function showError(message) {
    // Simple alert for now, you can replace with toast notification
    alert('Error: ' + message);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('columns-modal');
    if (event.target === modal) {
        closeColumnsModal();
    }
};

// Auto-refresh every 5 minutes
setInterval(() => {
    if (document.visibilityState === 'visible') {
        fetchLeads(currentPage);
    }
}, 300000);
</script>

<style>
/* Fix for sidebar compression */
body {
    overflow-x: hidden !important;
    min-width: 320px;
    background-color: #f8f9fa !important;
}

.main-content {
    overflow-x: hidden !important;
    width: calc(100vw - 250px) !important;
    box-sizing: border-box;
    background-color: #f8f9fa;
}

/* Navy Blue Theme (matching sidebar) */
.content-header {
    background: #0d6efd !important;
}

.kpi-card {
    background: white !important;
    border: 1px solid #dee2e6 !important;
    color: #495057 !important;
}

.filter-bar {
    background: white !important;
    border: 1px solid #dee2e6 !important;
}

.leads-table-wrapper {
    background: white !important;
    border: 1px solid #dee2e6 !important;
}

/* Table cell borders and BLACK TEXT */
#leads-table td {
    border: 1px solid #dee2e6 !important;
    font-size: 1.1em !important; /* Larger font size */
    padding: 16px !important; /* More padding for larger text */
    white-space: nowrap !important; /* No text wrapping */
    color: #000000 !important; /* BLACK TEXT */
}

/* Sticky columns - NO COLOR, just border */
.sticky-col, .sticky-col-right {
    background-color: inherit !important;
    border-right: 2px solid #dee2e6 !important;
    border-left: 2px solid #dee2e6 !important;
}

/* Lead ID - No color, plain black text */
.sticky-col a {
    font-size: 1.2em !important;
    font-weight: 700 !important;
    color: #000000 !important; /* BLACK TEXT */
    text-decoration: none !important;
}

.sticky-col a:hover {
    color: #0d6efd !important;
    text-decoration: underline !important;
}

/* Table headers with navy blue theme (matching sidebar) */
#leads-table th {
    background: #0d6efd !important; /* Sidebar color */
    color: white !important;
    font-size: 1.1em !important; /* Larger font size */
    font-weight: 600 !important;
}

/* Sticky column headers keep navy blue */
#leads-table .sticky-col,
#leads-table .sticky-col-right {
    background: #0d6efd !important; /* Same as other headers */
}

/* Header styles */
#leads-table th {
    position: sticky !important;
    top: 0 !important;
    z-index: 20 !important;
    white-space: nowrap !important;
    min-width: 120px !important;
    text-align: left !important;
    font-weight: 600 !important;
    border-bottom: 2px solid #0a58ca !important;
    transition: all 0.3s ease !important;
}

/* Better hover effects */
#leads-table th:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15) !important;
    background: #0a58ca !important;
}

/* Action button hover effects */
.btn-action:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.3) !important;
}

/* Progress bar colors for navy blue theme */
.bg-success { background: #198754 !important; }
.bg-info { background: #0dcaf0 !important; }
.bg-warning { background: #ffc107 !important; }
.bg-danger { background: #dc3545 !important; }
.bg-secondary { background: #6c757d !important; }
.bg-purple { background: #6f42c1 !important; }

/* Badge styles */
.badge {
    padding: 6px 14px !important;
    border-radius: 20px !important;
    font-size: 1.1em !important;
    font-weight: 600 !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #0d6efd;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #0a58ca;
}

/* Modal animation */
.modal-content {
    animation: modalSlideIn 0.3s ease-out;
    border: 2px solid #dee2e6 !important;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive design */
@media (max-width: 1200px) {
    .content-container {
        padding: 15px !important;
    }
    
    .filter-bar {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 15px !important;
    }
    
    .filter-bar > div {
        width: 100% !important;
    }
    
    .kpi-cards {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
    }
    
    #leads-table td,
    #leads-table th {
        font-size: 1em !important;
        padding: 14px !important;
    }
}

@media (max-width: 768px) {
    .main-content {
        padding: 10px !important;
        width: 100vw !important;
        margin-left: 0 !important;
    }
    
    .kpi-cards {
        grid-template-columns: 1fr !important;
    }
    
    .leads-table-wrapper {
        padding: 15px !important;
    }
    
    .filter-group {
        width: 100% !important;
    }
    
    #search-input {
        width: 100% !important;
    }
    
    .pagination {
        flex-direction: column !important;
        gap: 15px !important;
        align-items: center !important;
    }
    
    .modal-content {
        width: 95% !important;
        margin: 10% auto !important;
    }
    
    #leads-table td,
    #leads-table th {
        font-size: 0.95em !important;
        padding: 12px !important;
    }
}

@media (max-width: 480px) {
    .content-header h2 {
        font-size: 1.5em !important;
    }
    
    .action-buttons {
        flex-direction: column !important;
        gap: 6px !important;
    }
    
    .btn-action {
        width: 42px !important;
        height: 42px !important;
    }
    
    #leads-table td,
    #leads-table th {
        font-size: 0.9em !important;
        padding: 10px !important;
    }
}
</style>

<script>
// Initialize permission guards
document.addEventListener('DOMContentLoaded', function() {
    if (window.PermissionManager) {
        window.PermissionManager.init();
        window.PermissionManager.applyGuards();
    }
});
</script>
{% endblock %}